<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestión de Entregas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { padding-bottom: 90px; background-color: #f1f5f9; }
        .card-exit { transition: opacity 0.5s, transform 0.5s; }
        .card-exit-active { opacity: 0; transform: scale(0.9); }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .nav-item.active i, .nav-item.active span { color: #3b82f6; }
    </style>
</head>
<body class="font-sans">
    <div id="login-container" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <i class="ph-bold ph-truck text-6xl text-blue-500 mb-4"></i>
        <h2 class="text-2xl font-bold mb-6 text-slate-700">Gestor de Entregas</h2>
        <input id="usuario" type="text" placeholder="Usuario" class="mb-3 px-4 py-2 border rounded-lg w-72 focus:ring-2 focus:ring-blue-500 focus:outline-none" value="admin">
        <input id="clave" type="password" placeholder="Contraseña" class="mb-5 px-4 py-2 border rounded-lg w-72 focus:ring-2 focus:ring-blue-500 focus:outline-none" value="1234">
        <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-6 py-3 rounded-lg w-72 transition-transform active:scale-95">Entrar</button>
    </div>
    <div id="app-container" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-4xl mx-auto px-5 py-4 flex justify-between items-center">
                <h1 id="header-title" class="text-2xl font-bold text-slate-800">Entregas Pendientes</h1>
                <button id="refreshButton" class="text-slate-600 hover:text-blue-600 transition active:scale-90">
                    <i class="ph ph-arrow-clockwise text-3xl"></i>
                </button>
            </div>
        </header>
        <main id="lista-entregas" class="max-w-4xl mx-auto p-4"></main>
        <div id="mensaje-vacio" class="hidden text-center mt-16 px-4">
            <i id="mensaje-vacio-icono" class="ph ph-package text-6xl text-slate-400"></i>
            <p id="mensaje-vacio-texto" class="text-slate-500 mt-4 text-lg">No hay entregas.</p>
        </div>
        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-t-md border-t border-slate-200 h-[80px] z-20">
            <div class="max-w-4xl mx-auto h-full grid grid-cols-3">
                <button data-vista="Pendiente" class="nav-item flex flex-col items-center justify-center text-slate-500 active">
                    <i class="ph ph-clock-countdown text-3xl"></i><span class="text-xs font-medium">Pendientes</span>
                </button>
                <button data-vista="Entregado" class="nav-item flex flex-col items-center justify-center text-slate-500">
                    <i class="ph ph-check-circle text-3xl"></i><span class="text-xs font-medium">Entregadas</span>
                </button>
                <button data-vista="Cancelado" class="nav-item flex flex-col items-center justify-center text-slate-500">
                    <i class="ph ph-x-circle text-3xl"></i><span class="text-xs font-medium">Canceladas</span>
                </button>
            </div>
        </nav>
    </div>
    <div id="loader-global" class="hidden fixed inset-0 bg-white bg-opacity-75 flex justify-center items-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
    </div>
    <template id="tarjeta-entrega-template">
        <div class="bg-white rounded-lg shadow-md mb-4 overflow-hidden">
            <div class="p-5">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-sm font-semibold bg-blue-100 text-blue-800 px-3 py-1 rounded-full">ID: <span class="font-bold" data-id></span></span>
                    <div class="loader-card hidden w-6 h-6 border-4 border-t-4 border-gray-200 rounded-full animate-spin"></div>
                </div>
                <h2 class="text-xl font-bold text-slate-800" data-producto></h2>
                <p class="text-slate-600 mb-4" data-cliente></p>
                <div class="border-t border-slate-200 pt-4">
                    <a data-direccion-link href="#" target="_blank" class="flex items-center gap-3 group">
                        <i class="ph ph-map-pin text-2xl text-slate-500 group-hover:text-blue-600 transition"></i>
                        <div>
                            <p class="font-semibold text-slate-700 group-hover:text-blue-600 transition" data-direccion></p>
                            <span class="text-sm text-blue-500">Tocar para abrir en el mapa</span>
                        </div>
                    </a>
                </div>
            </div>
            <div class="grid grid-cols-2 btns-container">
                <button data-accion="Cancelado" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 transition flex items-center justify-center gap-2">
                    <i class="ph-fill ph-x-circle text-xl"></i>Cancelar
                </button>
                <button data-accion="Entregado" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 transition flex items-center justify-center gap-2">
                    <i class="ph-fill ph-check-circle text-xl"></i>Entregado
                </button>
            </div>
        </div>
    </template>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURACIÓN CORREGIDA ---
    // Añadimos "https://" al principio de la URL.
    const API_BASE_URL = 'https://AnalitycInventory.pythonanywhere.com';

    const listaEntregasContainer = document.getElementById('lista-entregas');
    const tarjetaTemplate = document.getElementById('tarjeta-entrega-template');
    const loaderGlobal = document.getElementById('loader-global');
    const mensajeVacio = document.getElementById('mensaje-vacio');
    const refreshButton = document.getElementById('refreshButton');
    const navItems = document.querySelectorAll('.nav-item');
    const headerTitle = document.getElementById('header-title');
    const mensajeVacioIcono = document.getElementById('mensaje-vacio-icono');
    const mensajeVacioTexto = document.getElementById('mensaje-vacio-texto');
    const loginContainer = document.getElementById('login-container');
    const loginBtn = document.getElementById('login-btn');
    const appContainer = document.getElementById('app-container');
    let allEntregas = [];
    let currentVista = 'Pendiente';

    loginBtn.addEventListener('click', () => {
        const usuario = document.getElementById('usuario').value;
        const clave = document.getElementById('clave').value;
        if (usuario === 'admin' && clave === '1234') {
            loginContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            fetchAllEntregas();
        } else {
            alert('Usuario o contraseña incorrectos');
        }
    });

    async function fetchAllEntregas() {
        showLoader(true);
        try {
            const response = await fetch(`${API_BASE_URL}/entregas`);
            if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
            allEntregas = await response.json();
            renderVista(currentVista);
        } catch (error) {
            console.error('Error fatal al cargar las entregas:', error);
            alert('ERROR AL CONECTAR CON LA API.\n\n1. Revisa que la URL de la API sea correcta.\n2. Asegúrate de que la API esté funcionando en PythonAnywhere.\n3. Verifica la configuración de CORS en tu main.py.');
        } finally {
            showLoader(false);
        }
    }

    function renderVista(vista) {
        listaEntregasContainer.innerHTML = '';
        mensajeVacio.classList.add('hidden');
        const entregasFiltradas = allEntregas.filter(entrega => entrega.estado === vista);
        headerTitle.textContent = `Entregas ${vista}s`;
        if (entregasFiltradas.length === 0) {
            mostrarMensajeVacio(vista);
        } else {
            entregasFiltradas.forEach(crearTarjetaEntrega);
        }
    }

    function crearTarjetaEntrega(entrega) {
        const card = tarjetaTemplate.content.cloneNode(true).firstElementChild;
        card.querySelector('[data-id]').textContent = entrega.id;
        card.querySelector('[data-producto]').textContent = entrega.producto;
        card.querySelector('[data-cliente]').textContent = `Cliente: ${entrega.cliente}`;
        card.querySelector('[data-direccion]').textContent = entrega.direccion;
        card.querySelector('[data-direccion-link]').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(entrega.direccion)}`;
        if (entrega.estado !== 'Pendiente') {
            card.querySelector('.btns-container').remove();
        } else {
            card.querySelectorAll('[data-accion]').forEach(button => {
                button.addEventListener('click', () => {
                    const nuevoEstado = button.dataset.accion;
                    actualizarEstado(entrega.id, nuevoEstado, card);
                });
            });
        }
        listaEntregasContainer.appendChild(card);
    }

    function mostrarMensajeVacio(vista) {
        const iconos = { Pendiente: 'ph-package', Entregado: 'ph-check-square-offset', Cancelado: 'ph-smiley-sad' };
        mensajeVacioIcono.className = `ph ${iconos[vista]} text-6xl text-slate-400`;
        mensajeVacioTexto.textContent = `No hay entregas en la sección de "${vista}s".`;
        mensajeVacio.classList.remove('hidden');
    }

    async function actualizarEstado(id, nuevoEstado, card) {
        const loaderCard = card.querySelector('.loader-card');
        const buttons = card.querySelectorAll('button');
        loaderCard.classList.remove('hidden');
        buttons.forEach(b => b.disabled = true);
        try {
            const response = await fetch(`${API_BASE_URL}/entregas/${id}/estado?nuevo_estado=${nuevoEstado}`, { method: 'PATCH' });
            if (!response.ok) throw new Error('La API rechazó la actualización.');
            card.classList.add('card-exit', 'card-exit-active');
            card.addEventListener('transitionend', () => { fetchAllEntregas(); });
        } catch (error) {
            console.error('Error al actualizar:', error);
            alert(`No se pudo actualizar la entrega ${id}.`);
            loaderCard.classList.add('hidden');
            buttons.forEach(b => b.disabled = false);
        }
    }

    function showLoader(visible) { loaderGlobal.classList.toggle('hidden', !visible); }
    refreshButton.addEventListener('click', fetchAllEntregas);
    navItems.forEach(item => {
        item.addEventListener('click', () => {
            currentVista = item.dataset.vista;
            navItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            renderVista(currentVista);
        });
    });
});
</script>
</body>
</html>
