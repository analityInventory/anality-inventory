<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise Gráfica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .form-input {
            padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1;
            border-radius: 0.5rem; background-color: white;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="font-sans">

    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
            <h1 id="header-title" class="text-2xl font-bold text-slate-800">Análise Gráfica</h1>
            <div>
                 <a href="index.html" class="text-slate-600 hover:text-blue-600 transition active:scale-90 mr-4" title="Voltar aos Pedidos">
                    <i class="ph ph-arrow-u-left-up text-3xl"></i>
                 </a>
                 <button id="logoutButton" class="text-slate-600 hover:text-red-600 transition active:scale-90" title="Sair">
                     <i class="ph ph-sign-out text-3xl"></i>
                 </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 lg:p-6">
        <div class="bg-white p-5 rounded-xl shadow-lg">
            <div class="flex flex-wrap items-center gap-4 mb-6 border-b pb-4">
                <div>
                    <label class="text-sm font-medium text-slate-600">Tipo de Análise:</label>
                    <select id="report-type" class="form-input mt-1">
                        <option>Resumen Financiero</option>
                        <option>Análisis de Gastos</option>
                        <option>Análisis de Productos</option>
                        <option>Evolución de Ganancia Neta</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-600">Desde:</label>
                    <input type="date" id="date-from" class="form-input mt-1">
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-600">Hasta:</label>
                    <input type="date" id="date-to" class="form-input mt-1">
                </div>
                <button id="generate-chart-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg self-end">Gerar</button>
            </div>
            
            <div id="chart-container" class="relative h-[60vh]">
                <canvas id="myChart"></canvas>
                <p id="no-data-message" class="hidden absolute inset-0 flex items-center justify-center text-slate-500">
                    Nenhum dado encontrado para o período selecionado.
                </p>
            </div>
        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIG & STATE ---
    const API_BASE_URL = 'https://mi-primera-app.fly.dev';
    let currentChart = null;
    const chartCanvas = document.getElementById('myChart');
    const noDataMessage = document.getElementById('no-data-message');
    const ctx = chartCanvas.getContext('2d');

    // --- SELECTORS ---
    const reportTypeSelect = document.getElementById('report-type');
    const dateFromInput = document.getElementById('date-from');
    const dateToInput = document.getElementById('date-to');
    const generateBtn = document.getElementById('generate-chart-btn');
    const headerTitle = document.getElementById('header-title');
    const logoutButton = document.getElementById('logoutButton');
    
    // --- API LOGIC ---
    function getAuthHeaders() {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        if (!token) { window.location.href = 'index.html'; return null; }
        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    async function fetchApi(endpoint, options = {}) {
        const headers = getAuthHeaders();
        if (!headers) return;
        const response = await fetch(`${API_BASE_URL}${endpoint}`, { headers, ...options });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido.' }));
            throw new Error(errorData.detail);
        }
        return response.json();
    }

    // --- CHART LOGIC ---
    async function plotChart() {
        if (currentChart) {
            currentChart.destroy();
        }
        noDataMessage.classList.add('hidden');
        chartCanvas.classList.remove('hidden');

        const reportType = reportTypeSelect.value;
        const fromDate = dateFromInput.value;
        const toDate = dateToInput.value;

        if (!fromDate || !toDate) {
            alert('Por favor, selecione um intervalo de datas.');
            return;
        }

        headerTitle.textContent = `${reportType} (${fromDate} a ${toDate})`;
        let endpoint = '';
        let chartOptions = {};
        
        try {
            switch (reportType) {
                case 'Resumen Financiero':
                    endpoint = `/analisis/resumen_financiero?start_date=${fromDate}&end_date=${toDate}`;
                    const financialData = await fetchApi(endpoint);
                    renderFinancialSummary(financialData);
                    break;
                case 'Análisis de Gastos':
                    endpoint = `/analisis/gastos_por_categoria?start_date=${fromDate}&end_date=${toDate}`;
                    const expenseData = await fetchApi(endpoint);
                    renderExpensesChart(expenseData);
                    break;
                case 'Análisis de Productos':
                    endpoint = `/analisis/top_productos?start_date=${fromDate}&end_date=${toDate}`;
                    const productData = await fetchApi(endpoint);
                    renderTopProductsChart(productData);
                    break;
                case 'Evolución de Ganancia Neta':
                    endpoint = `/analisis/ganancia_neta?start_date=${fromDate}&end_date=${toDate}`;
                    const profitData = await fetchApi(endpoint);
                    renderNetProfitChart(profitData);
                    break;
            }
        } catch (error) {
            alert(`Erro ao gerar gráfico: ${error.message}`);
            chartCanvas.classList.add('hidden');
            noDataMessage.textContent = `Erro ao carregar dados: ${error.message}`;
            noDataMessage.classList.remove('hidden');
        }
    }

    function renderFinancialSummary(data) {
        if (Object.keys(data).length === 0) {
            noDataMessage.classList.remove('hidden');
            chartCanvas.classList.add('hidden');
            return;
        }
        const labels = Object.keys(data).map(m => new Date(m + '-02').toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
        const ventas = Object.values(data).map(d => d.ventas);
        const gastos = Object.values(data).map(d => d.gastos);
        const inversiones = Object.values(data).map(d => d.inversiones);
        
        currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Ventas', data: ventas, backgroundColor: '#22c55e' },
                    { label: 'Gastos', data: gastos, backgroundColor: '#ef4444' },
                    { label: 'Inversiones', data: inversiones, backgroundColor: '#3b82f6' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    function renderExpensesChart(data) {
        if (data.length === 0) {
            noDataMessage.classList.remove('hidden');
            chartCanvas.classList.add('hidden');
            return;
        }
        const labels = data.map(d => d.categoria);
        const values = data.map(d => d.total_categoria);

        currentChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    label: 'Gastos por Categoria',
                    data: values,
                    backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderTopProductsChart(data) {
        if (data.length === 0) {
            noDataMessage.classList.remove('hidden');
            chartCanvas.classList.add('hidden');
            return;
        }
        const labels = data.map(d => d.product_name);
        const values = data.map(d => d.total_revenue);
        
        currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{ label: 'Ingresos por Producto', data: values, backgroundColor: '#16a34a' }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
        });
    }
    
    function renderNetProfitChart(data) {
        if (Object.keys(data).length === 0) {
            noDataMessage.classList.remove('hidden');
            chartCanvas.classList.add('hidden');
            return;
        }
        const labels = Object.keys(data).map(m => new Date(m + '-02').toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
        const netProfits = Object.values(data).map(d => d.total_ingresos - d.total_costos - d.total_gastos);
        
        currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{ 
                    label: 'Ganancia Neta', 
                    data: netProfits,
                    backgroundColor: netProfits.map(p => p >= 0 ? '#22c55e' : '#ef4444')
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
        });
    }

    // --- INITIALIZATION & EVENTS ---
    function setDefaultDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        dateToInput.value = today.toISOString().split('T')[0];
        dateFromInput.value = firstDay.toISOString().split('T')[0];
    }

    logoutButton.addEventListener('click', () => {
        localStorage.removeItem('authToken');
        sessionStorage.removeItem('authToken');
        window.location.href = 'index.html';
    });
    
    generateBtn.addEventListener('click', plotChart);

    setDefaultDates();
    plotChart(); // Cargar el gráfico inicial al cargar la página
});
</script>
</body>
</html>