<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AnalityInventory - Nova Venda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC17UyZO3QivEHPwYGz_2CmEkkiLy_DLlg&libraries=places&callback=initAutocomplete" async defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .view { transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s; position: absolute; width: 100%; top: 0; }
        .view-hidden-left { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .view-hidden-right { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 0.5rem; background-color: #334155; color: #f1f5f9; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .selection-badge { position: absolute; top: -10px; right: -10px; background-color: #3b82f6; color: white; font-weight: bold; font-size: 0.75rem; width: 28px; height: 28px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; border: 2px solid #0f172a; transform: scale(0); transition: transform 0.2s ease-out; }
        .product-card.selected .selection-badge { transform: scale(1); }
        .product-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .pac-container {
            background-color: #1e293b; border: 1px solid #475569; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000 !important;
        }
        .pac-item { padding: 10px; font-size: 1rem; color: #e2e8f0; border-top: 1px solid #334155; cursor: pointer; }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: #334155; }
        .pac-item-query { font-size: 1rem; color: #f1f5f9; }
    </style>
</head>
<body class="overflow-x-hidden">

    <header class="bg-slate-900/80 backdrop-blur-sm shadow-md sticky top-0 z-20 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Nova Venda</h1>
            <div>
                 <a href="index.html" class="text-slate-400 hover:text-white transition" title="Voltar ao Menu"><i class="ph ph-arrow-u-left-up text-3xl"></i></a>
            </div>
        </div>
    </header>

    <main class="relative">
        <div id="view-products" class="view">
            <div class="max-w-7xl mx-auto p-4 lg:p-6">
                <div class="sticky top-[88px] bg-slate-900/80 backdrop-blur-sm py-4 z-10">
                     <input type="search" id="product-search" placeholder="Buscar por nome, marca ou ID..." class="w-full text-lg px-4 py-3 form-input">
                </div>
                <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mt-4"></div>
            </div>
        </div>

        <div id="view-checkout" class="view view-hidden-right">
            <div class="max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3">Produtos Selecionados</h3>
                        <div id="cart-items" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            <p id="cart-empty-message" class="text-slate-400 text-center py-10">O carrinho está vazio</p>
                        </div>
                    </div>
                     <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3">Dados do Cliente</h3>
                        <div class="space-y-4">
                            <input id="customer-name" type="text" placeholder="Nome do Cliente *" class="form-input">
                            <input id="customer-address" type="text" placeholder="Endereço (para entrega)" class="form-input">
                            <input id="customer-phone" type="tel" placeholder="Telefone" class="form-input">
                        </div>
                        <div id="map-container" class="mt-4 hidden">
                            <div id="map" class="h-48 w-full rounded-lg bg-slate-700 border border-slate-600"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800 p-5 rounded-xl shadow-lg h-fit sticky top-[100px]">
                     <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3">Totais e Pagamento</h3>
                     <div class="space-y-3 text-lg">
                        <div class="flex justify-between items-center"><span class="text-slate-400">Subtotal:</span><span id="subtotal-value" class="font-semibold text-white">R$0.00</span></div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400">Entrega:</span>
                            <div class="flex items-center gap-2">
                                <span id="delivery-fee-modifier" class="text-xs font-semibold hidden"></span>
                                <input id="delivery-fee" type="number" value="0.00" min="0" step="0.50" class="w-28 font-semibold text-right form-input py-1">
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-2xl border-t border-slate-700 pt-3 mt-3"><span class="font-bold text-white">Total Geral:</span><span id="grand-total-value" class="font-bold text-blue-400">R$0.00</span></div>
                     </div>
                     <div class="grid grid-cols-2 gap-4 mt-6">
                        <div>
                            <label class="font-semibold text-slate-400 text-sm">Pagamento</label>
                            <select id="payment-method" class="w-full mt-1 p-2 form-input"><option>Dinheiro</option><option>Cartão</option><option>PIX</option></select>
                        </div>
                        <div>
                            <label class="font-semibold text-slate-400 text-sm">Entrega</label>
                             <select id="delivery-type" class="w-full mt-1 p-2 form-input"><option value="tienda">Retirar na Loja</option><option value="delivery">Delivery (Pedido)</option></select>
                        </div>
                     </div>
                     <button id="finalize-button" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-4 rounded-lg transition active:scale-95 flex items-center justify-center gap-3">
                        <i class="ph-bold ph-check-circle text-2xl"></i>Finalizar Venda
                    </button>
                </div>
            </div>
        </div>
    </main>

    <button id="checkout-view-btn" class="hidden fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full shadow-lg p-5 transition-transform transform active:scale-90"><i class="ph ph-arrow-right text-3xl"></i></button>
    <button id="products-view-btn" class="hidden fixed bottom-6 left-6 bg-slate-600 hover:bg-slate-700 text-white font-bold rounded-full shadow-lg p-5 transition-transform transform active:scale-90"><i class="ph ph-arrow-left text-3xl"></i></button>

    <template id="product-card-template">
        <div class="product-card bg-slate-800 border border-slate-700 rounded-lg p-3 flex flex-col items-center text-center shadow-sm hover:border-blue-500 transition cursor-pointer relative">
            <div class="selection-badge"></div>
            <div class="flex-grow"><h3 class="font-bold text-white leading-tight"></h3><p class="text-xs text-slate-400 mb-1" data-brand></p></div>
            <p class="text-lg font-semibold text-blue-400 my-2" data-price></p>
            <span class="text-xs bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full" data-stock></span>
        </div>
    </template>
    <template id="cart-item-template">
        <div class="flex items-center gap-3 py-2 border-b border-slate-700">
            <div class="flex-grow"><p class="font-semibold text-white"></p><p class="text-sm text-slate-400" data-price></p></div>
            <div class="flex items-center gap-2"><input type="number" min="1" value="1" class="w-16 text-center form-input py-1"><button data-action="remove" class="text-red-400 hover:text-red-300 p-1"><i class="ph ph-trash text-lg"></i></button></div>
        </div>
    </template>

<script>
function initAutocomplete() {
    const addressInput = document.getElementById('customer-address');
    
    // ===================================================================
    // LÍMITE DE BÚSQUEDA PARA MANAUS
    // ===================================================================
    const MANAUS_BOUNDS = {
        north: -2.98,
        south: -3.20,
        west: -60.10,
        east: -59.88,
    };

    const options = {
        componentRestrictions: { country: "br" },
        fields: ["formatted_address", "geometry"],
        types: ["address"],
        bounds: MANAUS_BOUNDS, // Prioriza resultados dentro de estos límites
        strictBounds: false, // Permite buscar fuera de los límites si es necesario
    };
    
    const autocomplete = new google.maps.places.Autocomplete(addressInput, options);

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place && place.geometry) {
            if (document.getElementById('delivery-type').value === 'delivery') {
                calculateAndShowRoute(place);
            }
        }
    });

    initializeAppLogic(autocomplete);
}

function initializeAppLogic(autocomplete) {
    const API_BASE_URL = 'https://mi-primera-app.fly.dev';
    
    // ===================================================================
    // NUEVA DIRECCIÓN DE LA TIENDA
    // ===================================================================
    const STORE_LOCATION = 'R. Garça Azul, 193 - São José Operário, Manaus - AM, 69086-692';

    // ===================================================================
    // NUEVA ESTRATEGIA DE PRECIOS POR TRAMOS (MÁS COMPETITIVA)
    // ===================================================================
    const DELIVERY_BASE_FEE = 3.00;      // Tarifa de partida
    const DELIVERY_MINIMUM_FEE = 8.00;  // Tarifa mínima
    const PEAK_HOUR_SURCHARGE = 3.00;   // Recargo de hora pico


    let allProducts = [], cart = [];
    let map, directionsService, directionsRenderer, geocoder;
    let lastGeocodedAddress = '';

    const productListContainer = document.getElementById('product-list');
    const searchInput = document.getElementById('product-search');
    const cartItemsContainer = document.getElementById('cart-items');
    const cartEmptyMessage = document.getElementById('cart-empty-message');
    const subtotalValueEl = document.getElementById('subtotal-value');
    const deliveryFeeEl = document.getElementById('delivery-fee');
    const deliveryFeeModifierEl = document.getElementById('delivery-fee-modifier');
    const grandTotalValueEl = document.getElementById('grand-total-value');
    const finalizeButton = document.getElementById('finalize-button');
    const deliveryTypeEl = document.getElementById('delivery-type');
    const mapContainer = document.getElementById('map-container');
    const addressInput = document.getElementById('customer-address');
    const viewProducts = document.getElementById('view-products');
    const viewCheckout = document.getElementById('view-checkout');
    const checkoutViewBtn = document.getElementById('checkout-view-btn');
    const productsViewBtn = document.getElementById('products-view-btn');

    function initMap() {
        directionsService = new google.maps.DirectionsService();
        geocoder = new google.maps.Geocoder();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
        const mapOptions = {
            zoom: 12, center: { lat: -3.07, lng: -59.98 }, disableDefaultUI: true,
            styles: [ { elementType: "geometry", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] }, { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] }, { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] }, { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] }, { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] }, { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] }, { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] }, { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] }, { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] }, { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] }, { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }, { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] }, ],
        };
        map = new google.maps.Map(document.getElementById("map"), mapOptions);
        directionsRenderer.setMap(map);
    }

    function getDynamicFeeModifier() {
        const now = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Manaus"}));
        const day = now.getDay();
        const hour = now.getHours();

        if (day >= 1 && day <= 5 && hour >= 11 && hour < 14) {
            return { type: 'surcharge', value: PEAK_HOUR_SURCHARGE, message: 'Adicional de pico' };
        }
        if (hour >= 18 && hour < 21) {
            return { type: 'surcharge', value: PEAK_HOUR_SURCHARGE, message: 'Adicional de pico' };
        }
        
        return { type: 'none', value: 0, message: '' };
    }


    function calculateAndShowRoute(destinationPlace) {
        if (!destinationPlace || !destinationPlace.geometry) return;
        
        mapContainer.style.display = 'block';
        if (!map) initMap();

        const request = { origin: STORE_LOCATION, destination: destinationPlace.geometry.location, travelMode: 'DRIVING' };

        directionsService.route(request, (result, status) => {
            deliveryFeeModifierEl.classList.add('hidden');

            if (status == 'OK') {
                directionsRenderer.setDirections(result);
                const route = result.routes[0].legs[0];
                const distanceInKm = route.distance.value / 1000;
                
                // ===================================================================
                // LÓGICA DE PRECIOS POR TRAMOS
                // ===================================================================
                let kmCost = 0;
                if (distanceInKm <= 5) {
                    kmCost = distanceInKm * 2.00; // R$2.00/km para los primeros 5km
                } else if (distanceInKm <= 15) {
                    kmCost = (5 * 2.00) + ((distanceInKm - 5) * 1.20); // Tarifa del primer tramo + R$1.20/km para el resto
                } else {
                    kmCost = (5 * 2.00) + (10 * 1.20) + ((distanceInKm - 15) * 0.90); // Tarifa de los dos primeros tramos + R$0.90/km para el resto
                }

                let fee = DELIVERY_BASE_FEE + kmCost;
                
                const modifier = getDynamicFeeModifier();
                if (modifier.type === 'surcharge') {
                    fee += modifier.value;
                    deliveryFeeModifierEl.textContent = modifier.message;
                    deliveryFeeModifierEl.className = 'text-xs font-semibold text-red-400';
                    deliveryFeeModifierEl.classList.remove('hidden');
                }

                if (fee < DELIVERY_MINIMUM_FEE) fee = DELIVERY_MINIMUM_FEE;
                
                deliveryFeeEl.value = fee.toFixed(2);
                updateTotals();
                new google.maps.Marker({ position: route.start_location, map: map, title: 'Sua Loja' });
                new google.maps.Marker({ position: route.end_location, map: map, title: 'Cliente' });
            } else {
                alert('Não foi possível calcular a rota. Verifique o endereço.');
                mapContainer.style.display = 'none';
            }
        });
    }
    
    function geocodeAddressAndCalculate() {
        const addressText = addressInput.value.trim();
        if (!addressText || addressText === lastGeocodedAddress) return;

        if (!geocoder) initMap();

        geocoder.geocode({ 'address': addressText, componentRestrictions: { country: 'br' } }, (results, status) => {
            if (status === 'OK' && results[0]) {
                lastGeocodedAddress = results[0].formatted_address;
                addressInput.value = lastGeocodedAddress;
                calculateAndShowRoute(results[0]);
            } else {
                console.error('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    function getAuthHeaders() { /* ... sin cambios ... */ return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('authToken') || sessionStorage.getItem('authToken')}` }; }
    async function fetchProducts() { /* ... sin cambios ... */ const h=getAuthHeaders();if(!h)return;try{const r=await fetch(`${API_BASE_URL}/products?out_of_stock=false`,{headers:h});if(!r.ok)throw new Error('...');allProducts=await r.json();renderProducts(allProducts)}catch(e){alert(e.message)}}
    function showCheckoutView() { /* ... sin cambios ... */ viewProducts.classList.add('view-hidden-left');viewCheckout.classList.remove('view-hidden-right');checkoutViewBtn.classList.add('hidden');productsViewBtn.classList.remove('hidden'); }
    function showProductsView() { /* ... sin cambios ... */ viewProducts.classList.remove('view-hidden-left');viewCheckout.classList.add('view-hidden-right');productsViewBtn.classList.add('hidden');updateCheckoutButtonVisibility(); }
    function renderProducts(productsToRender) { /* ... sin cambios ... */ productListContainer.innerHTML='';const t=document.getElementById('product-card-template');productsToRender.forEach(p=>{const c=t.content.cloneNode(true).firstElementChild;c.querySelector('h3').textContent=p.name;c.querySelector('[data-brand]').textContent=p.brand||'Sem Marca';c.querySelector('[data-price]').textContent=`R$${p.price.toFixed(2)}`;const s=c.querySelector('[data-stock]');s.textContent=`Estoque: ${p.stock}`;if(p.stock<5){s.classList.replace('bg-slate-700','bg-yellow-500/30');s.classList.replace('text-slate-300','text-yellow-300')}c.dataset.productId=p.id;productListContainer.appendChild(c)});updateAllProductCardSelections() }
    function renderCart() { /* ... sin cambios ... */ cartItemsContainer.innerHTML='';if(cart.length===0){cartItemsContainer.appendChild(cartEmptyMessage);cartEmptyMessage.hidden=false}else{cartEmptyMessage.hidden=true;const t=document.getElementById('cart-item-template');cart.forEach(i=>{const c=t.content.cloneNode(true).firstElementChild;c.querySelector('p').textContent=i.name;c.querySelector('[data-price]').textContent=`R$${i.price.toFixed(2)}`;const q=c.querySelector('input');q.value=i.quantity;q.max=i.stock;q.dataset.itemId=i.id;c.querySelector('[data-action="remove"]').dataset.itemId=i.id;cartItemsContainer.appendChild(c)})}updateTotals();updateCheckoutButtonVisibility() }
    function handleProductClick(productId) { /* ... sin cambios ... */ const p=allProducts.find(p=>p.id===productId);if(!p)return;const e=cart.find(i=>i.id===productId);if(e){if(e.quantity<p.stock){e.quantity++}else{alert('...')}}else{cart.push({...p,quantity:1})}renderCart();updateProductCardSelection(productId) }
    function handleProductLongPress(productId) { /* ... sin cambios ... */ const e=cart.find(i=>i.id===productId);if(e){cart=cart.filter(i=>i.id!==productId);renderCart();updateProductCardSelection(productId)} }
    function updateCartItemQuantity(productId, newQuantity) { /* ... sin cambios ... */ const c=cart.find(i=>i.id===productId);const p=allProducts.find(p=>p.id===productId);if(!c||!p)return;if(newQuantity<=0){removeFromCart(productId)}else if(newQuantity>p.stock){alert(`...`);c.quantity=p.stock;renderCart()}else{c.quantity=newQuantity}updateTotals();updateProductCardSelection(productId) }
    function removeFromCart(productId) { /* ... sin cambios ... */ cart=cart.filter(i=>i.id!==productId);renderCart();updateProductCardSelection(productId);if(cart.length===0){showProductsView()} }
    function updateTotals() { /* ... sin cambios ... */ const s=cart.reduce((s,i)=>s+(i.price*i.quantity),0);const d=parseFloat(deliveryFeeEl.value)||0;const g=s+d;subtotalValueEl.textContent=`R$${s.toFixed(2)}`;grandTotalValueEl.textContent=`R$${g.toFixed(2)}` }
    function updateProductCardSelection(productId) { /* ... sin cambios ... */ const c=productListContainer.querySelector(`[data-product-id='${productId}']`);if(!c)return;const i=cart.find(i=>i.id===productId);const b=c.querySelector('.selection-badge');if(i){c.classList.add('selected');b.textContent=`${i.quantity}x`}else{c.classList.remove('selected')} }
    function updateAllProductCardSelections() { /* ... sin cambios ... */ allProducts.forEach(p=>updateProductCardSelection(p.id)) }
    function updateCheckoutButtonVisibility() { /* ... sin cambios ... */ checkoutViewBtn.classList.toggle('hidden',cart.length===0) }
    async function finalizeSale() { /* ... sin cambios ... */ const c=document.getElementById('customer-name').value.trim();if(cart.length===0){alert('...');return}if(!c){alert('...');return}const d=document.getElementById('delivery-type').value;const o=d==='delivery'?'Pendiente':'Entregado';const p={customer_name:c,customer_address:document.getElementById('customer-address').value.trim(),customer_phone:document.getElementById('customer-phone').value.trim(),total:cart.reduce((s,i)=>s+(i.price*i.quantity),0)+(parseFloat(deliveryFeeEl.value)||0),payment_method:document.getElementById('payment-method').value,delivery_fee:parseFloat(deliveryFeeEl.value)||0,status:o,items:cart.map(i=>({id:i.id,quantity:i.quantity,price:i.price,costo:i.costo||0}))};const h=getAuthHeaders();if(!h)return;finalizeButton.disabled=true;finalizeButton.innerHTML='...';try{const r=await fetch(`${API_BASE_URL}/orders`,{method:'POST',headers:h,body:JSON.stringify(p)});if(!r.ok)throw new Error((await r.json()).detail||'...');const res=await r.json();alert(`Sucesso! Pedido #${res.order_id} criado.`);resetForm()}catch(e){alert(`Erro: ${e.message}`)}finally{finalizeButton.disabled=false;finalizeButton.innerHTML='...'}}
    function resetForm() { cart = []; document.getElementById('customer-name').value = ''; addressInput.value = ''; document.getElementById('customer-phone').value = ''; deliveryFeeEl.value = '0.00'; deliveryFeeModifierEl.classList.add('hidden'); mapContainer.style.display = 'none'; if(directionsRenderer) directionsRenderer.set('directions', null); renderCart(); showProductsView(); fetchProducts(); }

    searchInput.addEventListener('input', (e) => { const s=e.target.value.toLowerCase();const f=allProducts.filter(p=>p.name.toLowerCase().includes(s)||p.brand&&p.brand.toLowerCase().includes(s)||p.id.toString().includes(s));renderProducts(f) });
    productListContainer.addEventListener('click', (e) => { const c=e.target.closest('.product-card');if(c)handleProductClick(parseInt(c.dataset.productId)) });
    productListContainer.addEventListener('contextmenu', (e) => { const c=e.target.closest('.product-card');if(c){e.preventDefault();handleProductLongPress(parseInt(c.dataset.productId))} });
    document.body.addEventListener('change', (e) => { if (e.target.matches('#cart-items input[type="number"]')) { const i=parseInt(e.target.dataset.itemId);const n=parseInt(e.target.value);updateCartItemQuantity(i,n)} });
    document.body.addEventListener('click', (e) => { const b=e.target.closest('[data-action="remove"]');if(b)removeFromCart(parseInt(b.dataset.itemId)) });
    deliveryFeeEl.addEventListener('input', updateTotals);
    finalizeButton.addEventListener('click', finalizeSale);
    checkoutViewBtn.addEventListener('click', showCheckoutView);
    productsViewBtn.addEventListener('click', showProductsView);

    deliveryTypeEl.addEventListener('change', (e) => {
        if (e.target.value === 'delivery') {
            const place = autocomplete.getPlace();
            if (place && place.geometry) {
                calculateAndShowRoute(place);
            } else {
                geocodeAddressAndCalculate();
            }
        } else {
            deliveryFeeEl.value = '0.00';
            deliveryFeeModifierEl.classList.add('hidden');
            updateTotals();
            mapContainer.style.display = 'none';
        }
    });

    addressInput.addEventListener('blur', () => {
        if (deliveryTypeEl.value === 'delivery') {
            geocodeAddressAndCalculate();
        }
    });

    fetchProducts();
}
</script>
</body>
</html>
