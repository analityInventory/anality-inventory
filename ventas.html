<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AnalityInventory - Nova Venda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Librerías de Supabase y el guardián de seguridad -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js" defer></script>

    <!-- API de Google Maps. La función 'initApp' se llamará cuando esté lista -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC17UyZO3QivEHPwYGz_2CmEkkiLy_DLlg&libraries=places&callback=initApp" async defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .view { transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s; position: absolute; width: 100%; top: 0; }
        .view-hidden-left { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .view-hidden-right { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 0.5rem; background-color: #334155; color: #f1f5f9; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .form-input[readonly] { background-color: #475569; cursor: not-allowed; }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .selection-badge { position: absolute; top: -10px; right: -10px; background-color: #3b82f6; color: white; font-weight: bold; font-size: 0.75rem; width: 28px; height: 28px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; border: 2px solid #0f172a; transform: scale(0); transition: transform 0.2s ease-out; }
        .product-card.selected .selection-badge { transform: scale(1); }
        .product-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease, opacity 0.3s ease; }
        .language-selector { position: relative; }
        .language-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; background-color: #1e293b; border: 1px solid #334155; z-index: 50; }
        .language-selector:hover .language-dropdown { display: block; }
    </style>
</head>
<body class="overflow-x-hidden">

    <header class="bg-slate-900/80 backdrop-blur-sm shadow-md sticky top-0 z-20 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white" data-lang="header_title">Nova Venda</h1>
            <div class="flex items-center gap-4">
                <div class="language-selector">
                    <button class="text-slate-400 hover:text-white transition">
                        <i class="ph ph-translate text-3xl"></i>
                    </button>
                    <div class="language-dropdown rounded-md shadow-lg">
                        <a href="#" class="language-option block px-4 py-2 text-sm text-slate-300 hover:bg-blue-600 hover:text-white" data-lang-code="pt">Português</a>
                        <a href="#" class="language-option block px-4 py-2 text-sm text-slate-300 hover:bg-blue-600 hover:text-white" data-lang-code="es">Español</a>
                        <a href="#" class="language-option block px-4 py-2 text-sm text-slate-300 hover:bg-blue-600 hover:text-white" data-lang-code="en">English</a>
                    </div>
                </div>
                 <a href="index.html" class="text-slate-400 hover:text-white transition" title="Voltar ao Menu" data-lang-title="back_to_menu"><i class="ph ph-arrow-u-left-up text-3xl"></i></a>
            </div>
        </div>
    </header>

    <main class="relative">
        <div id="view-products" class="view">
            <div class="max-w-7xl mx-auto p-4 lg:p-6">
                <div class="sticky top-[88px] bg-slate-900/80 backdrop-blur-sm py-4 z-10">
                     <input type="search" id="product-search" placeholder="Buscar por nome, marca ou ID..." class="w-full text-lg px-4 py-3 form-input" data-lang-placeholder="search_placeholder">
                </div>
                <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mt-4"></div>
            </div>
        </div>

        <div id="view-checkout" class="view view-hidden-right">
            <div class="max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3" data-lang="selected_products">Produtos Selecionados</h3>
                        <div id="cart-items" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            <p id="cart-empty-message" class="text-slate-400 text-center py-10" data-lang="cart_empty">O carrinho está vazio</p>
                        </div>
                    </div>
                     <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3" data-lang="customer_data">Dados do Cliente e Entrega</h3>
                        <div class="space-y-4">
                            <input id="customer-name" type="text" placeholder="Nome do Cliente *" class="form-input" data-lang-placeholder="customer_name_placeholder">
                            <input id="customer-phone" type="tel" placeholder="Telefone" class="form-input" data-lang-placeholder="customer_phone_placeholder">
                            
                            <div class="grid grid-cols-3 gap-4 pt-2">
                                <div class="col-span-1">
                                    <label for="customer-cep" class="text-sm font-medium text-slate-400" data-lang="cep_label">CEP *</label>
                                    <input id="customer-cep" type="tel" placeholder="00000-000" class="form-input mt-1">
                                </div>
                                <div class="col-span-2">
                                    <label for="customer-street" class="text-sm font-medium text-slate-400" data-lang="street_label">Rua</label>
                                    <input id="customer-street" type="text" class="form-input mt-1" readonly>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="col-span-1">
                                    <label for="customer-number" class="text-sm font-medium text-slate-400" data-lang="number_label">Número *</label>
                                    <input id="customer-number" type="text" class="form-input mt-1">
                                </div>
                                <div class="col-span-2">
                                    <label for="customer-complement" class="text-sm font-medium text-slate-400" data-lang="complement_label">Complemento</label>
                                    <input id="customer-complement" type="text" placeholder="Apto, Bloco, etc." class="form-input mt-1" data-lang-placeholder="complement_placeholder">
                                </div>
                            </div>
                            <div>
                                <label for="customer-neighborhood" class="text-sm font-medium text-slate-400" data-lang="neighborhood_label">Bairro</label>
                                <input id="customer-neighborhood" type="text" class="form-input mt-1" readonly>
                            </div>
                             <input type="hidden" id="customer-city">
                            <input type="hidden" id="customer-state">
                        </div>
                        <div id="map-container" class="mt-4 hidden">
                            <div id="map" class="h-48 w-full rounded-lg bg-slate-700 border border-slate-600"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800 p-5 rounded-xl shadow-lg h-fit sticky top-[100px]">
                     <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3" data-lang="totals_payment">Totais e Pagamento</h3>
                     <div class="space-y-3 text-lg">
                        <div class="flex justify-between items-center"><span class="text-slate-400" data-lang="subtotal">Subtotal:</span><span id="subtotal-value" class="font-semibold text-white">R$0.00</span></div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400" data-lang="delivery">Entrega:</span>
                            <div class="flex items-center gap-2">
                                <span id="delivery-zone-label" class="text-xs font-semibold hidden rounded-full px-2 py-0.5"></span>
                                <input id="delivery-fee" type="number" value="0.00" min="0" step="0.50" class="w-28 font-semibold text-right form-input py-1">
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-2xl border-t border-slate-700 pt-3 mt-3"><span class="font-bold text-white" data-lang="grand_total">Total Geral:</span><span id="grand-total-value" class="font-bold text-blue-400">R$0.00</span></div>
                     </div>
                     <div class="grid grid-cols-2 gap-4 mt-6">
                        <div>
                            <label class="font-semibold text-slate-400 text-sm" data-lang="payment_method">Pagamento</label>
                            <select id="payment-method" class="w-full mt-1 p-2 form-input"><option data-lang="payment_cash">Dinheiro</option><option data-lang="payment_card">Cartão</option><option data-lang="payment_pix">PIX</option></select>
                        </div>
                        <div>
                            <label class="font-semibold text-slate-400 text-sm" data-lang="delivery_type">Entrega</label>
                             <select id="delivery-type" class="w-full mt-1 p-2 form-input"><option value="tienda" data-lang="delivery_pickup">Retirar na Loja</option><option value="delivery" data-lang="delivery_delivery">Delivery (Pedido)</option></select>
                        </div>
                     </div>
                     <button id="finalize-button" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-4 rounded-lg transition active:scale-95 flex items-center justify-center gap-3">
                        <i class="ph-bold ph-check-circle text-2xl"></i><span data-lang="finalize_button">Finalizar Venda</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Botones flotantes para cambiar de vista -->
    <button id="checkout-view-btn" class="hidden fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full shadow-lg p-5 transition-transform transform active:scale-90"><i class="ph ph-arrow-right text-3xl"></i></button>
    <button id="products-view-btn" class="hidden fixed bottom-6 left-6 bg-slate-600 hover:bg-slate-700 text-white font-bold rounded-full shadow-lg p-5 transition-transform transform active:scale-90"><i class="ph ph-arrow-left text-3xl"></i></button>

    <!-- Modales personalizados (Notificación y Confirmación) -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center p-4 modal-overlay opacity-0">
        <div class="modal-container opacity-0 scale-95 bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm border border-slate-700">
            <div class="p-6 text-center">
                <i id="alert-icon" class="text-5xl mx-auto mb-4"></i>
                <h3 id="alert-title" class="text-xl font-bold text-white mb-2"></h3>
                <p id="alert-message" class="text-slate-400"></p>
            </div>
            <div class="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-center">
                <button id="alert-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center p-4 modal-overlay opacity-0">
        <div class="modal-container opacity-0 scale-95 bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm border border-slate-700">
            <div class="p-6 text-center">
                <i class="ph ph-warning-circle text-5xl text-yellow-400 mx-auto mb-4"></i>
                <h3 id="confirmation-title" class="text-xl font-bold text-white mb-2"></h3>
                <p id="confirmation-message" class="text-slate-400"></p>
            </div>
            <div class="p-4 bg-slate-900/50 border-t border-slate-700 flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg" data-lang="form_cancel">Cancelar</button>
                <button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg" data-lang="confirm_button">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Plantillas -->
    <template id="product-card-template">
        <div class="product-card bg-slate-800 border border-slate-700 rounded-lg p-3 flex flex-col items-center text-center shadow-sm hover:border-blue-500 transition cursor-pointer relative">
            <div class="selection-badge"></div>
            <div class="flex-grow"><h3 class="font-bold text-white leading-tight"></h3><p class="text-xs text-slate-400 mb-1" data-brand></p></div>
            <p class="text-lg font-semibold text-blue-400 my-2" data-price></p>
            <span class="text-xs bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full" data-stock></span>
        </div>
    </template>
    <template id="cart-item-template">
        <div class="flex items-center gap-3 py-2 border-b border-slate-700">
            <div class="flex-grow"><p class="font-semibold text-white"></p><p class="text-sm text-slate-400" data-price></p></div>
            <div class="flex items-center gap-2"><input type="number" min="1" value="1" class="w-16 text-center form-input py-1"><button data-action="remove" class="text-red-400 hover:text-red-300 p-1"><i class="ph ph-trash text-lg"></i></button></div>
        </div>
    </template>

<script>
// La función initApp es llamada por la API de Google Maps cuando está lista.
function initApp() {
    // Variables globales de Google Maps
    let map, directionsService, geocoder;

    const API_BASE_URL = 'https://mi-primera-app.fly.dev';
    const STORE_LOCATION = 'R. Garça Azul, 193 - São José Operário, Manaus - AM, 69086-692';

    let allProducts = [], cart = [];
    let confirmCallback = null;

    // Selectores de elementos del DOM
    const productListContainer = document.getElementById('product-list');
    const searchInput = document.getElementById('product-search');
    const cartItemsContainer = document.getElementById('cart-items');
    const cartEmptyMessage = document.getElementById('cart-empty-message');
    const subtotalValueEl = document.getElementById('subtotal-value');
    const deliveryFeeEl = document.getElementById('delivery-fee');
    const deliveryZoneLabelEl = document.getElementById('delivery-zone-label');
    const grandTotalValueEl = document.getElementById('grand-total-value');
    const finalizeButton = document.getElementById('finalize-button');
    const deliveryTypeEl = document.getElementById('delivery-type');
    const mapContainer = document.getElementById('map-container');
    const viewProducts = document.getElementById('view-products');
    const viewCheckout = document.getElementById('view-checkout');
    const checkoutViewBtn = document.getElementById('checkout-view-btn');
    const productsViewBtn = document.getElementById('products-view-btn');
    const cepInput = document.getElementById('customer-cep');
    const streetInput = document.getElementById('customer-street');
    const numberInput = document.getElementById('customer-number');
    const complementInput = document.getElementById('customer-complement');
    const neighborhoodInput = document.getElementById('customer-neighborhood');
    const cityInput = document.getElementById('customer-city');
    const stateInput = document.getElementById('customer-state');

    // Selectores de modales
    const alertModal = document.getElementById('alert-modal');
    const alertIcon = document.getElementById('alert-icon');
    const alertTitle = document.getElementById('alert-title');
    const alertMessage = document.getElementById('alert-message');
    const alertOkBtn = document.getElementById('alert-ok-btn');
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmationTitle = document.getElementById('confirmation-title');
    const confirmationMessage = document.getElementById('confirmation-message');
    const confirmOkBtn = document.getElementById('confirm-ok-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');


    const translations = {
        pt: {
            header_title: "Nova Venda", back_to_menu: "Voltar ao Menu", search_placeholder: "Buscar por nome, marca ou ID...",
            selected_products: "Produtos Selecionados", cart_empty: "O carrinho está vazio", customer_data: "Dados do Cliente e Entrega",
            customer_name_placeholder: "Nome do Cliente *", customer_phone_placeholder: "Telefone", cep_label: "CEP *", street_label: "Rua",
            number_label: "Número *", complement_label: "Complemento", complement_placeholder: "Apto, Bloco, etc.", neighborhood_label: "Bairro",
            totals_payment: "Totais e Pagamento", subtotal: "Subtotal:", delivery: "Entrega:", grand_total: "Total Geral:",
            payment_method: "Pagamento", payment_cash: "Dinheiro", payment_card: "Cartão", payment_pix: "PIX",
            delivery_type: "Entrega", delivery_pickup: "Retirar na Loja", delivery_delivery: "Delivery (Pedido)",
            finalize_button: "Finalizar Venda", stock_label: "Estoque", no_brand: "Sem Marca",
            form_cancel: "Cancelar", confirm_button: "Confirmar",
            alert_success_title: "Sucesso", alert_error_title: "Erro", alert_info_title: "Aviso",
            sale_success: "Venda finalizada com sucesso! ID do Pedido:", cart_is_empty: "O carrinho está vazio.", customer_name_required: "O nome do cliente é obrigatório.",
            insufficient_stock: "Estoque insuficiente para o produto", could_not_calculate_route: "Não foi possível calcular a rota. Verifique o endereço e o número.",
            processing: "Processando..."
        },
        es: {
            header_title: "Nueva Venta", back_to_menu: "Volver al Menú", search_placeholder: "Buscar por nombre, marca o ID...",
            selected_products: "Productos Seleccionados", cart_empty: "El carrito está vacío", customer_data: "Datos del Cliente y Entrega",
            customer_name_placeholder: "Nombre del Cliente *", customer_phone_placeholder: "Teléfono", cep_label: "Cód. Postal *", street_label: "Calle",
            number_label: "Número *", complement_label: "Complemento", complement_placeholder: "Apto, Bloque, etc.", neighborhood_label: "Barrio",
            totals_payment: "Totales y Pago", subtotal: "Subtotal:", delivery: "Envío:", grand_total: "Total General:",
            payment_method: "Pago", payment_cash: "Efectivo", payment_card: "Tarjeta", payment_pix: "PIX",
            delivery_type: "Envío", delivery_pickup: "Retirar en Tienda", delivery_delivery: "Delivery (Pedido)",
            finalize_button: "Finalizar Venta", stock_label: "Existencias", no_brand: "Sin Marca",
            form_cancel: "Cancelar", confirm_button: "Confirmar",
            alert_success_title: "Éxito", alert_error_title: "Error", alert_info_title: "Aviso",
            sale_success: "¡Venta finalizada con éxito! ID del Pedido:", cart_is_empty: "El carrito está vacío.", customer_name_required: "El nombre del cliente es obligatorio.",
            insufficient_stock: "Existencias insuficientes para el producto", could_not_calculate_route: "No se pudo calcular la ruta. Verifica la dirección y el número.",
            processing: "Procesando..."
        },
        en: {
            header_title: "New Sale", back_to_menu: "Back to Menu", search_placeholder: "Search by name, brand, or ID...",
            selected_products: "Selected Products", cart_empty: "The cart is empty", customer_data: "Customer and Delivery Details",
            customer_name_placeholder: "Customer Name *", customer_phone_placeholder: "Phone", cep_label: "Postal Code *", street_label: "Street",
            number_label: "Number *", complement_label: "Complement", complement_placeholder: "Apt, Block, etc.", neighborhood_label: "Neighborhood",
            totals_payment: "Totals and Payment", subtotal: "Subtotal:", delivery: "Delivery:", grand_total: "Grand Total:",
            payment_method: "Payment", payment_cash: "Cash", payment_card: "Card", payment_pix: "PIX",
            delivery_type: "Delivery", delivery_pickup: "Store Pickup", delivery_delivery: "Delivery (Order)",
            finalize_button: "Finalize Sale", stock_label: "Stock", no_brand: "No Brand",
            form_cancel: "Cancel", confirm_button: "Confirm",
            alert_success_title: "Success", alert_error_title: "Error", alert_info_title: "Notice",
            sale_success: "Sale completed successfully! Order ID:", cart_is_empty: "The cart is empty.", customer_name_required: "Customer name is required.",
            insufficient_stock: "Insufficient stock for product", could_not_calculate_route: "Could not calculate the route. Please check the address and number.",
            processing: "Processing..."
        }
    };

    function getCurrentLanguage() {
        const savedLang = localStorage.getItem('userLanguage');
        const browserLang = navigator.language.split('-')[0];
        return savedLang || (translations[browserLang] ? browserLang : 'pt');
    }

    function setLanguage(lang) {
        if (!translations[lang]) return;
        localStorage.setItem('userLanguage', lang);
        document.querySelectorAll('[data-lang]').forEach(el => {
            const key = el.getAttribute('data-lang');
            if (translations[lang][key]) el.textContent = translations[lang][key];
        });
        document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
            const key = el.getAttribute('data-lang-placeholder');
            if (translations[lang][key]) el.placeholder = translations[lang][key];
        });
        document.querySelectorAll('[data-lang-title]').forEach(el => {
            const key = el.getAttribute('data-lang-title');
            if (translations[lang][key]) el.title = translations[lang][key];
        });
    }

    function loadLanguage() { setLanguage(getCurrentLanguage()); }

    function openModal(modal) {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('.modal-container').classList.remove('opacity-0', 'scale-95');
        }, 10);
    }

    function closeModal(modal) {
        modal.classList.add('opacity-0');
        modal.querySelector('.modal-container').classList.add('opacity-0', 'scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function showAlert(type, messageKey, messageParam = "") {
        const lang = getCurrentLanguage();
        let title = "";
        let iconClass = "";

        switch (type) {
            case 'success':
                title = translations[lang].alert_success_title;
                iconClass = 'ph ph-check-circle text-green-400';
                break;
            case 'error':
                title = translations[lang].alert_error_title;
                iconClass = 'ph ph-x-circle text-red-400';
                break;
            default:
                title = translations[lang].alert_info_title;
                iconClass = 'ph ph-info text-blue-400';
                break;
        }

        alertTitle.textContent = title;
        alertIcon.className = `text-5xl mx-auto mb-4 ${iconClass}`;
        alertMessage.textContent = (translations[lang][messageKey] || messageKey) + " " + messageParam;
        openModal(alertModal);
    }

    async function getAuthHeaders() {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error || !session) {
            console.error('Error de sesión o sesión no encontrada:', error);
            window.location.href = 'login.html';
            return null;
        }
        return { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${session.access_token}` 
        };
    }

    async function fetchApi(endpoint, options = {}) {
        const headers = await getAuthHeaders();
        if (!headers) throw new Error("Sessão de usuário não encontrada.");
        const response = await fetch(`${API_BASE_URL}${endpoint}`, { headers, ...options });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido.' }));
            throw new Error(errorData.detail);
        }
        if (response.status === 204) return null;
        return response.json();
    }

    async function fetchProducts() {
        try {
            allProducts = await fetchApi('/products?out_of_stock=false') || [];
            renderProducts(allProducts);
        } catch (e) {
            showAlert('error', e.message);
        }
    }

    async function searchCep() {
        const cep = cepInput.value.replace(/\D/g, '');
        if (cep.length !== 8) { clearAddressFields(); return; }
        streetInput.value = translations[getCurrentLanguage()].processing;
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            if (!response.ok) throw new Error('Falha na busca do CEP.');
            const data = await response.json();
            if (data.erro) {
                clearAddressFields();
                streetInput.value = "CEP não encontrado.";
                return;
            }
            streetInput.value = data.logradouro;
            neighborhoodInput.value = data.bairro;
            cityInput.value = data.localidade;
            stateInput.value = data.uf;
            numberInput.focus();
        } catch (error) {
            console.error(error);
            clearAddressFields();
            streetInput.value = "Erro ao buscar CEP.";
        }
    }

    function getFeeByZone(distanceInKm) {
        if (distanceInKm <= 4) return { fee: 8.00, name: 'Zona 1', color: 'bg-green-500/20 text-green-300' };
        if (distanceInKm <= 8) return { fee: 12.00, name: 'Zona 2', color: 'bg-blue-500/20 text-blue-300' };
        if (distanceInKm <= 15) return { fee: 18.00, name: 'Zona 3', color: 'bg-yellow-500/20 text-yellow-300' };
        if (distanceInKm <= 20) return { fee: 22.00, name: 'Zona 4', color: 'bg-orange-500/20 text-orange-300' };
        return { fee: 28.00, name: 'Zona 5', color: 'bg-red-500/20 text-red-300' };
    }

    async function calculateRouteFromAddress() {
        if (deliveryTypeEl.value !== 'delivery') {
            deliveryFeeEl.value = '0.00';
            updateTotals();
            mapContainer.style.display = 'none';
            return;
        }
        const fullAddress = `${streetInput.value}, ${numberInput.value}, ${neighborhoodInput.value}, ${cityInput.value} - ${stateInput.value}`;
        if (!streetInput.value || !numberInput.value) return;
        mapContainer.style.display = 'block';
        const request = { origin: STORE_LOCATION, destination: fullAddress, travelMode: 'DRIVING' };
        try {
            const result = await directionsService.route(request);
            deliveryZoneLabelEl.classList.add('hidden');
            if (result.routes.length > 0) {
                const route = result.routes[0].legs[0];
                const distanceInKm = route.distance.value / 1000;
                const zoneInfo = getFeeByZone(distanceInKm);
                deliveryFeeEl.value = zoneInfo.fee.toFixed(2);
                deliveryZoneLabelEl.textContent = zoneInfo.name;
                deliveryZoneLabelEl.className = `text-xs font-semibold rounded-full px-2 py-0.5 ${zoneInfo.color}`;
                deliveryZoneLabelEl.classList.remove('hidden');
                updateTotals();
                if (!map) {
                    map = new google.maps.Map(document.getElementById("map"), { zoom: 15, center: route.start_location, disableDefaultUI: true });
                }
                const directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
                directionsRenderer.setDirections(result);
            } else {
                throw new Error("Não foi possível encontrar a rota.");
            }
        } catch (error) {
            console.error('Error al calcular la ruta:', error);
            showAlert('error', 'could_not_calculate_route');
            mapContainer.style.display = 'none';
        }
    }

    function showCheckoutView() { viewProducts.classList.add('view-hidden-left');viewCheckout.classList.remove('view-hidden-right');checkoutViewBtn.classList.add('hidden');productsViewBtn.classList.remove('hidden'); }
    function showProductsView() { viewProducts.classList.remove('view-hidden-left');viewCheckout.classList.add('view-hidden-right');productsViewBtn.classList.add('hidden');updateCheckoutButtonVisibility(); }
    
    function renderProducts(productsToRender) {
        productListContainer.innerHTML = '';
        const t = document.getElementById('product-card-template');
        const lang = getCurrentLanguage();
        productsToRender.forEach(p => {
            const c = t.content.cloneNode(true).firstElementChild;
            c.querySelector('h3').textContent = p.name;
            c.querySelector('[data-brand]').textContent = p.brand || translations[lang].no_brand;
            c.querySelector('[data-price]').textContent = `R$${p.price.toFixed(2)}`;
            const s = c.querySelector('[data-stock]');
            s.textContent = `${translations[lang].stock_label}: ${p.stock}`;
            if (p.stock < 5) {
                s.classList.replace('bg-slate-700', 'bg-yellow-500/30');
                s.classList.replace('text-slate-300', 'text-yellow-300');
            }
            c.dataset.productId = p.id;
            productListContainer.appendChild(c);
        });
        updateAllProductCardSelections();
    }

    function renderCart() {
        cartItemsContainer.innerHTML = '';
        if (cart.length === 0) {
            cartItemsContainer.appendChild(cartEmptyMessage);
            cartEmptyMessage.hidden = false;
        } else {
            cartEmptyMessage.hidden = true;
            const t = document.getElementById('cart-item-template');
            cart.forEach(i => {
                const c = t.content.cloneNode(true).firstElementChild;
                c.querySelector('p').textContent = i.name;
                c.querySelector('[data-price]').textContent = `R$${i.price.toFixed(2)}`;
                const q = c.querySelector('input');
                q.value = i.quantity;
                q.max = i.stock;
                q.dataset.itemId = i.id;
                c.querySelector('[data-action="remove"]').dataset.itemId = i.id;
                cartItemsContainer.appendChild(c);
            });
        }
        updateTotals();
        updateCheckoutButtonVisibility();
    }

    function handleProductClick(productId) {
        const p = allProducts.find(p => p.id === productId);
        if (!p) return;
        const e = cart.find(i => i.id === productId);
        if (e) {
            if (e.quantity < p.stock) {
                e.quantity++;
            } else {
                showAlert('info', 'insufficient_stock', p.name);
            }
        } else {
            cart.push({ ...p, quantity: 1 });
        }
        renderCart();
        updateProductCardSelection(productId);
    }

    function handleProductLongPress(productId) {
        const e = cart.find(i => i.id === productId);
        if (e) {
            cart = cart.filter(i => i.id !== productId);
            renderCart();
            updateProductCardSelection(productId);
        }
    }

    function updateCartItemQuantity(productId, newQuantity) {
        const c = cart.find(i => i.id === productId);
        const p = allProducts.find(p => p.id === productId);
        if (!c || !p) return;
        if (newQuantity <= 0) {
            removeFromCart(productId);
        } else if (newQuantity > p.stock) {
            showAlert('info', 'insufficient_stock', p.name);
            c.quantity = p.stock;
            renderCart();
        } else {
            c.quantity = newQuantity;
        }
        updateTotals();
        updateProductCardSelection(productId);
    }

    function removeFromCart(productId) {
        cart = cart.filter(i => i.id !== productId);
        renderCart();
        updateProductCardSelection(productId);
        if (cart.length === 0) { showProductsView(); }
    }

    function updateTotals() {
        const s = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
        const d = parseFloat(deliveryFeeEl.value) || 0;
        const g = s + d;
        subtotalValueEl.textContent = `R$${s.toFixed(2)}`;
        grandTotalValueEl.textContent = `R$${g.toFixed(2)}`;
    }

    function updateProductCardSelection(productId) {
        const c = productListContainer.querySelector(`[data-product-id='${productId}']`);
        if (!c) return;
        const i = cart.find(i => i.id === productId);
        const b = c.querySelector('.selection-badge');
        if (i) {
            c.classList.add('selected');
            b.textContent = `${i.quantity}x`;
        } else {
            c.classList.remove('selected');
        }
    }

    function updateAllProductCardSelections() { allProducts.forEach(p => updateProductCardSelection(p.id)); }
    function updateCheckoutButtonVisibility() { checkoutViewBtn.classList.toggle('hidden', cart.length === 0); }
    
    async function finalizeSale() {
        const customerName = document.getElementById('customer-name').value.trim();
        if (cart.length === 0) { showAlert('info', 'cart_is_empty'); return; }
        if (!customerName) { showAlert('info', 'customer_name_required'); return; }
        
        const fullAddress = `${streetInput.value}, ${numberInput.value}, ${complementInput.value} - ${neighborhoodInput.value}, ${cityInput.value} - ${stateInput.value}`.replace(/, ,/g, ',');
        const payload = {
            customer_name: customerName,
            customer_address: fullAddress,
            customer_phone: document.getElementById('customer-phone').value.trim(),
            total: cart.reduce((s, i) => s + (i.price * i.quantity), 0) + (parseFloat(deliveryFeeEl.value) || 0),
            payment_method: document.getElementById('payment-method').value,
            delivery_fee: parseFloat(deliveryFeeEl.value) || 0,
            status: deliveryTypeEl.value === 'delivery' ? 'Pendiente' : 'Entregado',
            items: cart.map(item => ({ id: item.id, quantity: item.quantity, price: item.price, costo: item.costo || 0 }))
        };
        
        finalizeButton.disabled = true;
        finalizeButton.querySelector('span').textContent = translations[getCurrentLanguage()].processing;
        finalizeButton.insertAdjacentHTML('afterbegin', '<div class="spinner mr-3"></div>');

        try {
            const result = await fetchApi('/orders', { method: 'POST', body: JSON.stringify(payload) });
            showAlert('success', 'sale_success', `#${result.order_id}`);
            resetForm();
        } catch (error) {
            showAlert('error', error.message);
        } finally {
            finalizeButton.disabled = false;
            finalizeButton.querySelector('span').textContent = translations[getCurrentLanguage()].finalize_button;
            const spinner = finalizeButton.querySelector('.spinner');
            if (spinner) spinner.remove();
        }
    }
    
    function resetForm() {
        cart = [];
        document.getElementById('customer-name').value = '';
        document.getElementById('customer-phone').value = '';
        cepInput.value = '';
        numberInput.value = '';
        complementInput.value = '';
        clearAddressFields();
        deliveryFeeEl.value = '0.00';
        deliveryZoneLabelEl.classList.add('hidden');
        mapContainer.style.display = 'none';
        renderCart();
        showProductsView();
        fetchProducts();
    }

    function clearAddressFields() {
        streetInput.value = '';
        neighborhoodInput.value = '';
        cityInput.value = '';
        stateInput.value = '';
    }

    // Inicialización de Google Maps y lógica principal
    try {
        directionsService = new google.maps.DirectionsService();
        geocoder = new google.maps.Geocoder();
    } catch (e) {
        console.error("Google Maps services could not be initialized.");
        showAlert('error', "Could not load Google Maps. Please check your connection and API key.");
    }
    
    // Event Listeners
    cepInput.addEventListener('blur', searchCep);
    numberInput.addEventListener('blur', calculateRouteFromAddress);
    deliveryTypeEl.addEventListener('change', calculateRouteFromAddress);
    searchInput.addEventListener('input', (e) => { const s = e.target.value.toLowerCase(); const f = allProducts.filter(p => p.name.toLowerCase().includes(s) || (p.brand && p.brand.toLowerCase().includes(s)) || p.id.toString().includes(s)); renderProducts(f); });
    productListContainer.addEventListener('click', (e) => { const c = e.target.closest('.product-card'); if (c) handleProductClick(parseInt(c.dataset.productId)); });
    productListContainer.addEventListener('contextmenu', (e) => { const c = e.target.closest('.product-card'); if (c) { e.preventDefault(); handleProductLongPress(parseInt(c.dataset.productId)); } });
    document.body.addEventListener('change', (e) => { if (e.target.matches('#cart-items input[type="number"]')) { const i = parseInt(e.target.dataset.itemId); const n = parseInt(e.target.value); updateCartItemQuantity(i, n); } });
    document.body.addEventListener('click', (e) => { const b = e.target.closest('[data-action="remove"]'); if (b) removeFromCart(parseInt(b.dataset.itemId)); });
    deliveryFeeEl.addEventListener('input', updateTotals);
    finalizeButton.addEventListener('click', finalizeSale);
    checkoutViewBtn.addEventListener('click', showCheckoutView);
    productsViewBtn.addEventListener('click', showProductsView);
    alertOkBtn.addEventListener('click', () => closeModal(alertModal));
    document.querySelectorAll('.language-option').forEach(b => b.addEventListener('click', (e) => { e.preventDefault(); setLanguage(e.target.dataset.langCode); }));

    // Inicialización
    loadLanguage();
    fetchProducts();
}
</script>
</body>
</html>
</body>
</html>
