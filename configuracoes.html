<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AnalityInventory - Configurações</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts de Supabase y Autenticación -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js" defer></script>
    <!-- NUEVO: Gestor de Temas -->
    <script src="theme-manager.js" defer></script>

    <style>
        /* Estilos base para tema claro */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            color: #0f172a; /* slate-900 */
            transition: background-color 0.3s, color 0.3s;
        }
        .form-input {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem; transition: all 0.2s;
            border: 1px solid #cbd5e1; /* slate-300 */
            background-color: #ffffff; /* white */
            color: #0f172a; /* slate-900 */
        }
        .form-input:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        .card {
            background-color: #ffffff; /* white */
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        .header {
            background-color: rgba(255, 255, 255, 0.8); /* white/80 */
            border-bottom-color: #e2e8f0; /* slate-200 */
        }
        .text-main { color: #0f172a; }
        .text-secondary { color: #475569; }
        .border-color { border-color: #e2e8f0; }
        .theme-button.active { background-color: #3b82f6; color: white; }
        .theme-button { background-color: #e2e8f0; }

        /* Estilos para tema oscuro */
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        .dark .form-input { border-color: #475569; background-color: #334155; color: #f1f5f9; }
        .dark .card { background-color: #1e293b; border-color: #334155; }
        .dark .header { background-color: rgba(15, 23, 42, 0.8); border-bottom-color: #334155; }
        .dark .text-main { color: #e2e8f0; }
        .dark .text-secondary { color: #94a3b8; }
        .dark .border-color { border-color: #334155; }
        .dark .theme-button.active { background-color: #3b82f6; color: white; }
        .dark .theme-button { background-color: #334155; }

        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease, opacity 0.3s ease; }
        .language-selector { position: relative; }
        .language-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; z-index: 50; }
        .language-selector:hover .language-dropdown { display: block; }
    </style>
</head>
<body class="font-sans">

    <header class="header backdrop-blur-sm shadow-md sticky top-0 z-20 border-b">
        <div class="max-w-4xl mx-auto px-5 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-main" data-lang="header_title">Configurações</h1>
            <div class="flex items-center gap-4">
                <div class="language-selector">
                    <button class="text-secondary hover:text-main transition">
                        <i class="ph ph-translate text-3xl"></i>
                    </button>
                    <div class="language-dropdown card rounded-md shadow-lg">
                        <a href="#" class="language-option block px-4 py-2 text-sm text-secondary hover:bg-blue-600 hover:text-white" data-lang-code="pt">Português</a>
                        <a href="#" class="language-option block px-4 py-2 text-sm text-secondary hover:bg-blue-600 hover:text-white" data-lang-code="es">Español</a>
                        <a href="#" class="language-option block px-4 py-2 text-sm text-secondary hover:bg-blue-600 hover:text-white" data-lang-code="en">English</a>
                    </div>
                </div>
                 <a href="index.html" class="text-secondary hover:text-main transition" title="Voltar ao Menu" data-lang-title="back_to_menu">
                    <i class="ph ph-arrow-u-left-up text-3xl"></i>
                 </a>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 lg:p-8 space-y-12">
        <!-- Sección de Perfil de Usuario -->
        <div class="card p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-main border-b border-color pb-4 mb-6" data-lang="profile_title">Perfil de Usuário</h2>
            <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="relative">
                    <img id="profile-avatar" src="https://placehold.co/128x128/334155/e2e8f0?text=U" alt="User Avatar" class="w-32 h-32 rounded-full object-cover border-4 border-color">
                </div>
                <div class="flex-grow w-full">
                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label for="profile-email" class="block text-sm font-medium text-secondary" data-lang="email_label">Email</label>
                            <input type="email" id="profile-email" class="form-input mt-1 bg-slate-200 dark:bg-slate-600 cursor-not-allowed" readonly>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="profile-name" class="block text-sm font-medium text-secondary" data-lang="name_label">Nome</label>
                                <input type="text" id="profile-name" class="form-input mt-1">
                            </div>
                            <div>
                                <label for="profile-phone" class="block text-sm font-medium text-secondary" data-lang="phone_label">Telefone</label>
                                <input type="tel" id="profile-phone" class="form-input mt-1">
                            </div>
                        </div>
                        <div class="pt-2">
                            <button type="submit" class="btn btn-primary" data-lang="save_profile_btn">Salvar Perfil</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sección de Seguridad -->
        <div class="card p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-main border-b border-color pb-4 mb-6" data-lang="security_title">Segurança</h2>
            <div class="max-w-md">
                <h3 class="text-lg font-semibold mb-2" data-lang="change_password_title">Alterar Senha</h3>
                <form id="change-password-form" class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-secondary" data-lang="current_password_label">Senha Atual</label>
                        <input type="password" id="current-password" class="form-input mt-1" required>
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-secondary" data-lang="new_password_label">Nova Senha</label>
                        <input type="password" id="new-password" class="form-input mt-1" required>
                    </div>
                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-secondary" data-lang="confirm_password_label">Confirmar Nova Senha</label>
                        <input type="password" id="confirm-password" class="form-input mt-1" required>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="btn btn-primary" data-lang="save_changes_btn">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sección de Temas -->
        <div class="card p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-main border-b border-color pb-4 mb-6" data-lang="appearance_title">Aparência</h2>
            <div>
                <h3 class="text-lg font-semibold mb-2" data-lang="select_theme_title">Selecionar Tema</h3>
                <div id="theme-selector" class="flex items-center gap-2 mt-4">
                    <button data-theme="light" class="theme-button flex items-center gap-2 py-2 px-4 rounded-lg">
                        <i class="ph ph-sun"></i> <span data-lang="theme_light">Claro</span>
                    </button>
                    <button data-theme="dark" class="theme-button flex items-center gap-2 py-2 px-4 rounded-lg">
                        <i class="ph ph-moon"></i> <span data-lang="theme_dark">Escuro</span>
                    </button>
                    <button data-theme="system" class="theme-button flex items-center gap-2 py-2 px-4 rounded-lg">
                        <i class="ph ph-desktop"></i> <span data-lang="theme_system">Sistema</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Alerta -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center p-4">
        <div class="modal-container opacity-0 scale-95 card rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6 text-center">
                <i id="alert-icon" class="text-5xl mx-auto mb-4"></i>
                <h3 id="alert-title" class="text-xl font-bold text-main mb-2"></h3>
                <p id="alert-message" class="text-secondary"></p>
            </div>
            <div class="p-4 bg-slate-100 dark:bg-slate-900/50 border-t border-color flex justify-center">
                <button id="alert-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = 'https://mi-primera-app.fly.dev';
    const profileForm = document.getElementById('profile-form');
    const changePasswordForm = document.getElementById('change-password-form');
    const themeSelector = document.getElementById('theme-selector');
    
    // Selectores de modales
    const alertModal = document.getElementById('alert-modal');
    const alertIcon = document.getElementById('alert-icon');
    const alertTitle = document.getElementById('alert-title');
    const alertMessage = document.getElementById('alert-message');
    const alertOkBtn = document.getElementById('alert-ok-btn');

    const translations = {
        pt: {
            header_title: "Configurações", back_to_menu: "Voltar ao Menu", profile_title: "Perfil de Usuário",
            email_label: "Email", name_label: "Nome", phone_label: "Telefone", save_profile_btn: "Salvar Perfil",
            security_title: "Segurança", change_password_title: "Alterar Senha", current_password_label: "Senha Atual", 
            new_password_label: "Nova Senha", confirm_password_label: "Confirmar Nova Senha", save_changes_btn: "Salvar Alterações",
            appearance_title: "Aparência", select_theme_title: "Selecionar Tema",
            theme_light: "Claro", theme_dark: "Escuro", theme_system: "Sistema",
            alert_success_title: "Sucesso", alert_error_title: "Erro", alert_info_title: "Aviso",
            password_mismatch: "A nova senha e a confirmação não coincidem.",
            password_too_short: "A nova senha deve ter pelo menos 6 caracteres.",
            password_changed_success: "Senha alterada com sucesso!",
            error_changing_password: "Não foi possível alterar a senha.",
            profile_updated_success: "Perfil atualizado com sucesso!",
            error_updating_profile: "Erro ao atualizar o perfil."
        },
        es: {
            header_title: "Configuraciones", back_to_menu: "Volver al Menú", profile_title: "Perfil de Usuario",
            email_label: "Email", name_label: "Nombre", phone_label: "Teléfono", save_profile_btn: "Guardar Perfil",
            security_title: "Seguridad", change_password_title: "Cambiar Contraseña", current_password_label: "Contraseña Actual",
            new_password_label: "Nueva Contraseña", confirm_password_label: "Confirmar Nueva Contraseña", save_changes_btn: "Guardar Cambios",
            appearance_title: "Apariencia", select_theme_title: "Seleccionar Tema",
            theme_light: "Claro", theme_dark: "Oscuro", theme_system: "Sistema",
            alert_success_title: "Éxito", alert_error_title: "Error", alert_info_title: "Aviso",
            password_mismatch: "La nueva contraseña y la confirmación no coinciden.",
            password_too_short: "La nueva contraseña debe tener al menos 6 caracteres.",
            password_changed_success: "¡Contraseña cambiada con éxito!",
            error_changing_password: "No se pudo cambiar la contraseña.",
            profile_updated_success: "¡Perfil actualizado con éxito!",
            error_updating_profile: "Error al actualizar el perfil."
        }
    };

    function getCurrentLanguage() { const savedLang = localStorage.getItem('userLanguage'); const browserLang = navigator.language.split('-')[0]; return savedLang || (translations[browserLang] ? browserLang : 'pt'); }
    function setLanguage(lang) { if (!translations[lang]) lang = 'pt'; localStorage.setItem('userLanguage', lang); document.querySelectorAll('[data-lang]').forEach(el => { const key = el.getAttribute('data-lang'); if (translations[lang][key]) el.textContent = translations[lang][key]; }); document.querySelectorAll('[data-lang-title]').forEach(el => { const key = el.getAttribute('data-lang-title'); if (translations[lang][key]) el.title = translations[lang][key]; }); }
    function loadLanguage() { setLanguage(getCurrentLanguage()); }

    function openModal(modal) { modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-container').classList.remove('opacity-0', 'scale-95'); }, 10); }
    function closeModal(modal) { modal.classList.add('opacity-0'); modal.querySelector('.modal-container').classList.add('opacity-0', 'scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); }
    function showAlert(type, messageKey, messageParam = "") { const lang = getCurrentLanguage(); let title = "", iconClass = ""; switch (type) { case 'success': title = translations[lang].alert_success_title; iconClass = 'ph ph-check-circle text-green-400'; break; case 'error': title = translations[lang].alert_error_title; iconClass = 'ph ph-x-circle text-red-400'; break; default: title = translations[lang].alert_info_title; iconClass = 'ph ph-info text-blue-400'; break; } alertTitle.textContent = title; alertIcon.className = `text-5xl mx-auto mb-4 ${iconClass}`; alertMessage.textContent = (translations[lang][messageKey] || messageKey) + " " + messageParam; openModal(alertModal); }

    async function getAuthHeaders() { const { data: { session }, error } = await supabase.auth.getSession(); if (error || !session) { window.location.href = 'login.html'; return null; } return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` }; }
    async function fetchApi(endpoint, options = {}) { const headers = await getAuthHeaders(); if (!headers) throw new Error("Sessão de usuário não encontrada."); const response = await fetch(`${API_BASE_URL}${endpoint}`, { headers, ...options }); if (!response.ok) { const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido.' })); if (response.status === 401) { showAlert('error', 'Sessão expirada ou não autorizada. Por favor, faça login novamente.'); setTimeout(() => window.location.href = 'login.html', 3000); } throw new Error(errorData.detail); } if (response.status === 204) return null; return response.json(); }

    async function loadUserProfile() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            document.getElementById('profile-email').value = user.email;
            document.getElementById('profile-name').value = user.user_metadata.name || '';
            document.getElementById('profile-phone').value = user.user_metadata.phone || '';
            const avatarUrl = user.user_metadata.avatar_url || `https://placehold.co/128x128/334155/e2e8f0?text=${user.email[0].toUpperCase()}`;
            document.getElementById('profile-avatar').src = avatarUrl;
        }
    }

    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('profile-name').value;
        const phone = document.getElementById('profile-phone').value;
        try {
            const { error } = await supabase.auth.updateUser({
                data: { name, phone }
            });
            if (error) throw error;
            showAlert('success', 'profile_updated_success');
        } catch (error) {
            showAlert('error', 'error_updating_profile', error.message);
        }
    });

    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        if (newPassword !== confirmPassword) {
            showAlert('info', 'password_mismatch');
            return;
        }
        if (newPassword.length < 6) {
            showAlert('info', 'password_too_short');
            return;
        }
        try {
            const { error } = await supabase.auth.updateUser({ password: newPassword });
            if (error) throw error;
            showAlert('success', 'password_changed_success');
            changePasswordForm.reset();
        } catch (error) {
            showAlert('error', 'error_changing_password', error.message);
        }
    });

    function updateThemeButtons() {
        const currentTheme = localStorage.getItem('theme') || 'system';
        document.querySelectorAll('.theme-button').forEach(button => {
            button.classList.toggle('active', button.dataset.theme === currentTheme);
        });
    }
    
    themeSelector.addEventListener('click', (e) => {
        const button = e.target.closest('.theme-button');
        if (button) {
            const theme = button.dataset.theme;
            setTheme(theme); // La función setTheme está en theme-manager.js
            updateThemeButtons();
        }
    });
    
    alertOkBtn.addEventListener('click', () => closeModal(alertModal));
    document.querySelectorAll('.language-option').forEach(b => b.addEventListener('click', e => { e.preventDefault(); setLanguage(e.target.dataset.langCode); }));

    loadLanguage();
    loadUserProfile();
    updateThemeButtons();
});
</script>

</body>
</html>
