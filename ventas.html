<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AnalityInventory - Nova Venda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .view { transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s; position: absolute; width: 100%; top: 0; }
        .view-hidden-left { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .view-hidden-right { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 0.5rem; background-color: #334155; color: #f1f5f9; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .selection-badge { position: absolute; top: -10px; right: -10px; background-color: #3b82f6; color: white; font-weight: bold; font-size: 0.75rem; width: 28px; height: 28px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; border: 2px solid #0f172a; transform: scale(0); transition: transform 0.2s ease-out; }
        .product-card.selected .selection-badge { transform: scale(1); }
        .product-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
    </style>
</head>
<body class="overflow-x-hidden">

    <header class="bg-slate-900/80 backdrop-blur-sm shadow-md sticky top-0 z-20 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Nova Venda</h1>
            <div>
                 <a href="index.html" class="text-slate-400 hover:text-white transition" title="Voltar ao Menu"><i class="ph ph-arrow-u-left-up text-3xl"></i></a>
            </div>
        </div>
    </header>

    <main class="relative">
        <!-- Vista 1: Selección de Productos -->
        <div id="view-products" class="view">
            <div class="max-w-7xl mx-auto p-4 lg:p-6">
                <div class="sticky top-[88px] bg-slate-900/80 backdrop-blur-sm py-4 z-10">
                     <input type="search" id="product-search" placeholder="Buscar por nome, marca ou ID..." class="w-full text-lg px-4 py-3 form-input">
                </div>
                <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mt-4"></div>
            </div>
        </div>

        <!-- Vista 2: Carrito y Finalización -->
        <div id="view-checkout" class="view view-hidden-right">
            <div class="max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3">Produtos Selecionados</h3>
                        <div id="cart-items" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            <p id="cart-empty-message" class="text-slate-400 text-center py-10">O carrinho está vazio</p>
                        </div>
                    </div>
                     <div class="bg-slate-800 p-5 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3">Dados do Cliente</h3>
                        <div class="space-y-4">
                            <input id="customer-name" type="text" placeholder="Nome do Cliente *" class="form-input">
                            <input id="customer-address" type="text" placeholder="Endereço (para entrega)" class="form-input">
                            <input id="customer-phone" type="tel" placeholder="Telefone" class="form-input">
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800 p-5 rounded-xl shadow-lg h-fit sticky top-[100px]">
                     <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-3">Totais e Pagamento</h3>
                     <div class="space-y-3 text-lg">
                        <div class="flex justify-between items-center"><span class="text-slate-400">Subtotal:</span><span id="subtotal-value" class="font-semibold text-white">R$0.00</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-400">Entrega:</span><input id="delivery-fee" type="number" value="0.00" min="0" step="0.50" class="w-28 font-semibold text-right form-input py-1"></div>
                        <div class="flex justify-between items-center text-2xl border-t border-slate-700 pt-3 mt-3"><span class="font-bold text-white">Total Geral:</span><span id="grand-total-value" class="font-bold text-blue-400">R$0.00</span></div>
                     </div>
                     <div class="grid grid-cols-2 gap-4 mt-6">
                        <div>
                            <label class="font-semibold text-slate-400 text-sm">Pagamento</label>
                            <select id="payment-method" class="w-full mt-1 p-2 form-input"><option>Dinheiro</option><option>Cartão</option><option>PIX</option></select>
                        </div>
                        <div>
                            <label class="font-semibold text-slate-400 text-sm">Entrega</label>
                             <select id="delivery-type" class="w-full mt-1 p-2 form-input"><option value="tienda">Retirar na Loja</option><option value="delivery">Delivery (Pedido)</option></select>
                        </div>
                     </div>
                     <button id="finalize-button" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-4 rounded-lg transition active:scale-95 flex items-center justify-center gap-3">
                        <i class="ph-bold ph-check-circle text-2xl"></i>Finalizar Venda
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Botones flotantes -->
    <button id="checkout-view-btn" class="hidden fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full shadow-lg p-5 transition-transform transform active:scale-90"><i class="ph ph-arrow-right text-3xl"></i></button>
    <button id="products-view-btn" class="hidden fixed bottom-6 left-6 bg-slate-600 hover:bg-slate-700 text-white font-bold rounded-full shadow-lg p-5 transition-transform transform active:scale-90"><i class="ph ph-arrow-left text-3xl"></i></button>

    <!-- Templates -->
    <template id="product-card-template">
        <div class="product-card bg-slate-800 border border-slate-700 rounded-lg p-3 flex flex-col items-center text-center shadow-sm hover:border-blue-500 transition cursor-pointer relative">
            <div class="selection-badge"></div>
            <div class="flex-grow"><h3 class="font-bold text-white leading-tight"></h3><p class="text-xs text-slate-400 mb-1" data-brand></p></div>
            <p class="text-lg font-semibold text-blue-400 my-2" data-price></p>
            <span class="text-xs bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full" data-stock></span>
        </div>
    </template>
    <template id="cart-item-template">
        <div class="flex items-center gap-3 py-2 border-b border-slate-700">
            <div class="flex-grow"><p class="font-semibold text-white"></p><p class="text-sm text-slate-400" data-price></p></div>
            <div class="flex items-center gap-2"><input type="number" min="1" value="1" class="w-16 text-center form-input py-1"><button data-action="remove" class="text-red-400 hover:text-red-300 p-1"><i class="ph ph-trash text-lg"></i></button></div>
        </div>
    </template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIG & STATE ---
    const API_BASE_URL = 'https://mi-primera-app.fly.dev';
    let allProducts = [];
    let cart = [];

    // --- SELECTORS ---
    const productListContainer = document.getElementById('product-list');
    const searchInput = document.getElementById('product-search');
    const cartItemsContainer = document.getElementById('cart-items');
    const cartEmptyMessage = document.getElementById('cart-empty-message');
    const subtotalValueEl = document.getElementById('subtotal-value');
    const deliveryFeeEl = document.getElementById('delivery-fee');
    const grandTotalValueEl = document.getElementById('grand-total-value');
    const finalizeButton = document.getElementById('finalize-button');
    const deliveryTypeEl = document.getElementById('delivery-type');
    
    const viewProducts = document.getElementById('view-products');
    const viewCheckout = document.getElementById('view-checkout');
    const checkoutViewBtn = document.getElementById('checkout-view-btn');
    const productsViewBtn = document.getElementById('products-view-btn');

    // --- API LOGIC ---
    function getAuthHeaders() {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        if (!token) { window.location.href = 'login.html'; return null; }
        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    async function fetchProducts() {
        const headers = getAuthHeaders();
        if (!headers) return;
        try {
            const response = await fetch(`${API_BASE_URL}/products?out_of_stock=false`, { headers });
            if (!response.ok) throw new Error('Não foi possível carregar os produtos.');
            allProducts = await response.json();
            renderProducts(allProducts);
        } catch (error) {
            alert(error.message);
        }
    }
    
    // --- VIEW TRANSITIONS ---
    function showCheckoutView() {
        viewProducts.classList.add('view-hidden-left');
        viewCheckout.classList.remove('view-hidden-right');
        checkoutViewBtn.classList.add('hidden');
        productsViewBtn.classList.remove('hidden');
    }

    function showProductsView() {
        viewProducts.classList.remove('view-hidden-left');
        viewCheckout.classList.add('view-hidden-right');
        productsViewBtn.classList.add('hidden');
        updateCheckoutButtonVisibility();
    }

    // --- RENDER LOGIC ---
    function renderProducts(productsToRender) {
        productListContainer.innerHTML = '';
        const template = document.getElementById('product-card-template');
        productsToRender.forEach(product => {
            const card = template.content.cloneNode(true).firstElementChild;
            card.querySelector('h3').textContent = product.name;
            card.querySelector('[data-brand]').textContent = product.brand || 'Sem Marca';
            card.querySelector('[data-price]').textContent = `R$${product.price.toFixed(2)}`;
            const stockEl = card.querySelector('[data-stock]');
            stockEl.textContent = `Estoque: ${product.stock}`;
            if (product.stock < 5) {
                stockEl.classList.replace('bg-slate-700', 'bg-yellow-500/30');
                stockEl.classList.replace('text-slate-300', 'text-yellow-300');
            }
            card.dataset.productId = product.id;
            productListContainer.appendChild(card);
        });
        updateAllProductCardSelections();
    }

    function renderCart() {
        cartItemsContainer.innerHTML = '';
        if (cart.length === 0) {
            cartItemsContainer.appendChild(cartEmptyMessage);
            cartEmptyMessage.hidden = false;
        } else {
            cartEmptyMessage.hidden = true;
            const template = document.getElementById('cart-item-template');
            cart.forEach(item => {
                const cartItemEl = template.content.cloneNode(true).firstElementChild;
                cartItemEl.querySelector('p').textContent = item.name;
                cartItemEl.querySelector('[data-price]').textContent = `R$${item.price.toFixed(2)}`;
                const quantityInput = cartItemEl.querySelector('input');
                quantityInput.value = item.quantity;
                quantityInput.max = item.stock;
                quantityInput.dataset.itemId = item.id;
                cartItemEl.querySelector('[data-action="remove"]').dataset.itemId = item.id;
                cartItemsContainer.appendChild(cartItemEl);
            });
        }
        updateTotals();
        updateCheckoutButtonVisibility();
    }
    
    // --- BUSINESS LOGIC ---
    function handleProductClick(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;
        const existingCartItem = cart.find(item => item.id === productId);

        if (existingCartItem) {
            if (existingCartItem.quantity < product.stock) {
                existingCartItem.quantity++;
            } else {
                alert('Não há mais estoque disponível para este produto.');
            }
        } else {
            cart.push({ ...product, quantity: 1 });
        }
        
        renderCart();
        updateProductCardSelection(productId);
    }

    function handleProductLongPress(productId) {
        const existingCartItem = cart.find(item => item.id === productId);
        if (existingCartItem) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
            updateProductCardSelection(productId);
        }
    }
    
    function updateCartItemQuantity(productId, newQuantity) {
        const cartItem = cart.find(item => item.id === productId);
        const product = allProducts.find(p => p.id === productId);
        if (!cartItem || !product) return;

        if (newQuantity <= 0) {
            removeFromCart(productId);
        } else if (newQuantity > product.stock) {
            alert(`Estoque máximo para ${product.name} é ${product.stock}.`);
            cartItem.quantity = product.stock;
            renderCart();
        } else {
            cartItem.quantity = newQuantity;
        }
        updateTotals();
        updateProductCardSelection(productId);
    }

    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        renderCart();
        updateProductCardSelection(productId);
        if (cart.length === 0) {
            showProductsView();
        }
    }

    function updateTotals() {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryFee = parseFloat(deliveryFeeEl.value) || 0;
        const grandTotal = subtotal + deliveryFee;
        
        subtotalValueEl.textContent = `R$${subtotal.toFixed(2)}`;
        grandTotalValueEl.textContent = `R$${grandTotal.toFixed(2)}`;
    }
    
    // --- UI UPDATE FUNCTIONS ---
    function updateProductCardSelection(productId) {
        const card = productListContainer.querySelector(`[data-product-id='${productId}']`);
        if (!card) return;
        const cartItem = cart.find(item => item.id === productId);
        const badge = card.querySelector('.selection-badge');

        if (cartItem) {
            card.classList.add('selected');
            badge.textContent = `${cartItem.quantity}x`;
        } else {
            card.classList.remove('selected');
        }
    }

    function updateAllProductCardSelections() {
        allProducts.forEach(p => updateProductCardSelection(p.id));
    }

    function updateCheckoutButtonVisibility() {
        checkoutViewBtn.classList.toggle('hidden', cart.length === 0);
    }

    async function finalizeSale() {
        const customerName = document.getElementById('customer-name').value.trim();
        if (cart.length === 0) { alert('O carrinho está vazio.'); return; }
        if (!customerName) { alert('O nome do cliente é obrigatório.'); return; }

        // --- INICIO DE LA MODIFICACIÓN ---

        // 1. Obtener el tipo de entrega seleccionado del <select>
        const deliveryType = document.getElementById('delivery-type').value;

        // 2. Determinar el estado del pedido basado en el tipo de entrega
        let orderStatus;
        if (deliveryType === 'delivery') {
            orderStatus = 'Pendiente'; // Si es delivery, el pedido queda pendiente de envío.
        } else { // Si es 'tienda' o cualquier otro valor
            orderStatus = 'Entregado'; // Si se retira en tienda, se considera entregado al momento.
        }

        // 3. Construir el payload con el estado dinámico
        const payload = {
            customer_name: customerName,
            customer_address: document.getElementById('customer-address').value.trim(),
            customer_phone: document.getElementById('customer-phone').value.trim(),
            total: cart.reduce((s, i) => s + (i.price * i.quantity), 0) + (parseFloat(deliveryFeeEl.value) || 0),
            payment_method: document.getElementById('payment-method').value,
            delivery_fee: parseFloat(deliveryFeeEl.value) || 0,
            status: orderStatus, // Usamos la variable con el estado correcto
            items: cart.map(item => ({ id: item.id, quantity: item.quantity, price: item.price, costo: item.costo || 0 }))
        };
        
        // --- FIN DE LA MODIFICACIÓN ---
        
        const headers = getAuthHeaders();
        if (!headers) return;
        
        finalizeButton.disabled = true;
        finalizeButton.innerHTML = '<div class="spinner"></div> Processando...';

        try {
            // ... el resto de la función no necesita cambios ...
            const response = await fetch(`${API_BASE_URL}/orders`, { method: 'POST', headers, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error((await response.json()).detail || 'Ocorreu um erro.');
            const result = await response.json();
            alert(`Sucesso! Pedido #${result.order_id} criado corretamente.`);
            resetForm();
        } catch (error) {
            alert(`Erro: ${error.message}`);
        } finally {
            finalizeButton.disabled = false;
            finalizeButton.innerHTML = '<i class="ph-bold ph-check-circle text-2xl"></i> Finalizar Venda';
        }
    }

    function resetForm() {
        cart = [];
        document.getElementById('customer-name').value = '';
        document.getElementById('customer-address').value = '';
        document.getElementById('customer-phone').value = '';
        deliveryFeeEl.value = '0.00';
        renderCart();
        showProductsView();
        fetchProducts();
    }

    // --- EVENT LISTENERS ---
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.brand && p.brand.toLowerCase().includes(searchTerm)) || p.id.toString().includes(searchTerm));
        renderProducts(filtered);
    });
    
    productListContainer.addEventListener('click', (e) => {
        const card = e.target.closest('.product-card');
        if (card) handleProductClick(parseInt(card.dataset.productId));
    });

    // **NUEVO EVENTO PARA LONG PRESS**
    productListContainer.addEventListener('contextmenu', (e) => {
        const card = e.target.closest('.product-card');
        if (card) {
            e.preventDefault(); // Prevenir el menú contextual del navegador
            handleProductLongPress(parseInt(card.dataset.productId));
        }
    });

    document.body.addEventListener('change', (e) => {
        if (e.target.matches('#cart-items input[type="number"]')) {
            const itemId = parseInt(e.target.dataset.itemId);
            const newQuantity = parseInt(e.target.value);
            updateCartItemQuantity(itemId, newQuantity);
        }
    });

    document.body.addEventListener('click', (e) => {
        const button = e.target.closest('[data-action="remove"]');
        if (button) removeFromCart(parseInt(button.dataset.itemId));
    });
    
    deliveryFeeEl.addEventListener('input', updateTotals);
    finalizeButton.addEventListener('click', finalizeSale);
    checkoutViewBtn.addEventListener('click', showCheckoutView);
    productsViewBtn.addEventListener('click', showProductsView);

    // --- INITIALIZATION ---
    fetchProducts();
});
</script>
</body>
</html>

</body>
</html>
