<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gest√£o de Investimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .form-input {
            width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1;
            border-radius: 0.5rem; transition: ring 0.2s;
        }
        .form-input:focus {
            outline: none; --tw-ring-color: #3b82f6;
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow, 0 0 #0000);
            border-color: #3b82f6;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="font-sans">

    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-slate-800">Gest√£o de Investimentos</h1>
            <div>
                 <a href="index.html" class="text-slate-600 hover:text-blue-600 transition active:scale-90 mr-4" title="Voltar aos Pedidos">
                    <i class="ph ph-arrow-u-left-up text-3xl"></i>
                 </a>
                 <button id="logoutButton" class="text-slate-600 hover:text-red-600 transition active:scale-90" title="Sair">
                     <i class="ph ph-sign-out text-3xl"></i>
                 </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-2">
            
            <div class="bg-white p-5 rounded-xl shadow-lg mb-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Resumen de Inversiones</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-slate-500 text-sm">üí∞ Valor Total</p>
                        <p id="total-invested-value" class="text-2xl font-bold text-slate-800">R$0.00</p>
                    </div>
                     <div>
                        <p class="text-slate-500 text-sm">üöö En Camino</p>
                        <p id="total-on-the-way-value" class="text-2xl font-bold text-blue-600">R$0.00</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">‚úÖ Recibido</p>
                        <p id="total-received-value" class="text-2xl font-bold text-green-600">R$0.00</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">‚ö†Ô∏è Retenido</p>
                        <p id="total-retained-value" class="text-2xl font-bold text-yellow-600">R$0.00</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 items-center">
                    <input type="text" id="search-input" placeholder="Buscar por descripci√≥n o tracking..." class="form-input">
                    <select id="status-filter" class="form-input">
                        <option value="Todos">Todos os Status</option>
                        <option value="En Camino">En Camino</option>
                        <option value="Recibido">Recibido</option>
                        <option value="Retenido">Retenido</option>
                    </select>
                </div>
                <div id="investment-list" class="h-[calc(100vh-380px)] overflow-y-auto pr-2 space-y-4">
                    </div>
                 <p id="no-investments-message" class="hidden text-center text-slate-500 py-16">Nenhuma inversi√≥n encontrada.</p>
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="bg-white p-5 rounded-xl shadow-lg sticky top-[88px]">
                <h3 id="form-title" class="text-xl font-bold text-slate-800 mb-4 border-b pb-3">Adicionar Novo Investimento</h3>
                <form id="investment-form" class="space-y-4">
                    <input type="hidden" id="investment-id">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Descri√ß√£o *</label>
                        <input type="text" id="inv-description" class="form-input mt-1" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Custo de Envio (R$)</label>
                            <input type="number" id="inv-shipping-cost" min="0" step="0.01" value="0" class="form-input mt-1">
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-slate-700">Status *</label>
                            <select id="inv-status" class="form-input mt-1" required>
                                <option value="En Camino">En Camino</option>
                                <option value="Recibido">Recibido</option>
                                <option value="Retenido">Retenido</option>
                            </select>
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Data de Envio</label>
                            <input type="date" id="inv-shipping-date" class="form-input mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Data de Chegada</label>
                            <input type="date" id="inv-arrival-date" class="form-input mt-1">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">N¬∫ de Tracking</label>
                        <input type="text" id="inv-tracking" class="form-input mt-1">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-slate-700">Observa√ß√µes</label>
                        <textarea id="inv-obs" rows="2" class="form-input mt-1"></textarea>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-slate-700 mb-2">Produtos no Pacote</h4>
                        <ul id="item-list" class="space-y-2 text-sm">
                           </ul>
                         <button type="button" id="add-item-btn" class="mt-2 w-full text-blue-600 font-semibold border-2 border-dashed border-blue-400 hover:bg-blue-50 py-2 rounded-lg transition">
                            + Adicionar Produto
                        </button>
                    </div>

                    <div class="flex gap-4 pt-2">
                        <button type="submit" id="save-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">Salvar</button>
                        <button type="button" id="clear-button" class="w-auto bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-4 rounded-lg transition">Limpar</button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-start pt-20 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-4 border-b">
                <h2 class="text-xl font-bold text-slate-800">Selecionar Produto</h2>
                <input type="text" id="product-search-input" placeholder="Buscar produto..." class="form-input mt-2">
            </div>
            <div id="product-list-container" class="max-h-80 overflow-y-auto">
                </div>
             <div class="p-4 bg-slate-50 border-t flex justify-end">
                <button id="close-product-modal" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg transition">Fechar</button>
            </div>
        </div>
    </div>


    <template id="investment-card-template">
         <div class="bg-slate-50 border border-slate-200 rounded-lg shadow-sm">
            <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="font-bold text-lg text-slate-800" data-description></p>
                        <p class="text-sm text-slate-500">ID: <span data-id></span></p>
                    </div>
                    <span class="px-3 py-1 text-xs font-bold rounded-full text-white" data-status></span>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm mt-3 border-t pt-3">
                    <div>
                        <p class="font-semibold">Valor dos Produtos:</p>
                        <p data-items-value></p>
                    </div>
                     <div>
                        <p class="font-semibold">Custo Total:</p>
                        <p class="font-bold" data-total-value></p>
                    </div>
                    <div>
                        <p class="font-semibold">N¬∫ Tracking:</p>
                        <a href="#" target="_blank" class="text-blue-600 hover:underline" data-tracking></a>
                    </div>
                     <div>
                        <p class="font-semibold">Data de Envio:</p>
                        <p data-shipping-date></p>
                    </div>
                </div>
                 <div class="mt-4 border-t pt-3">
                    <p class="font-semibold text-sm mb-2">Produtos Inclusos:</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-slate-600" data-items>
                        </ul>
                </div>
            </div>
            <div class="bg-slate-100 p-2 flex justify-end gap-2">
                <button data-action="edit" class="text-sm font-semibold text-blue-600 hover:text-blue-800 py-1 px-3 rounded" title="Editar"><i class="ph ph-pencil-simple mr-1"></i>Editar</button>
                <button data-action="delete" class="text-sm font-semibold text-red-600 hover:text-red-800 py-1 px-3 rounded" title="Excluir"><i class="ph ph-trash mr-1"></i>Excluir</button>
            </div>
        </div>
    </template>
    
    <template id="item-list-row-template">
        <li class="flex justify-between items-center p-2 bg-slate-100 rounded">
            <span class="item-text"></span>
            <button type="button" class="item-remove-btn text-red-500 hover:text-red-700">
                <i class="ph ph-x-circle text-lg"></i>
            </button>
        </li>
    </template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIG & STATE ---
    const API_BASE_URL = 'https://mi-primera-app.fly.dev';
    let allInvestments = [];
    let editingInvestmentId = null;
    let formItems = []; // Almacena los productos para el formulario actual

    // --- SELECTORS ---
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const investmentListContainer = document.getElementById('investment-list');
    const noInvestmentsMessage = document.getElementById('no-investments-message');
    const investmentForm = document.getElementById('investment-form');
    const formTitle = document.getElementById('form-title');
    const saveButton = document.getElementById('save-button');
    const clearButton = document.getElementById('clear-button');
    const logoutButton = document.getElementById('logoutButton');
    
    const addItemBtn = document.getElementById('add-item-btn');
    const productModal = document.getElementById('product-modal');
    const closeProductModalBtn = document.getElementById('close-product-modal');
    const productSearchInput = document.getElementById('product-search-input');
    const productListContainer = document.getElementById('product-list-container');
    const itemListEl = document.getElementById('item-list');

    // --- API LOGIC ---
    function getAuthHeaders() {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        if (!token) { window.location.href = 'index.html'; return null; }
        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    async function fetchApi(endpoint, options = {}) {
        const headers = getAuthHeaders();
        if (!headers) return;
        const response = await fetch(`${API_BASE_URL}${endpoint}`, { headers, ...options });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido.' }));
            throw new Error(errorData.detail);
        }
        if (response.status === 204) return null;
        return response.json();
    }
    
    // --- DATA LOADING & RENDERING ---
    async function loadInvestments() {
        try {
            const status = statusFilter.value;
            const filterText = searchInput.value;
            const params = new URLSearchParams({
                ...(status !== 'Todos' && { status }),
                ...(filterText && { filter_text: filterText })
            });
            allInvestments = await fetchApi(`/inversiones?${params.toString()}`);
            renderInvestments();
        } catch (error) {
            alert(`Erro ao carregar investimentos: ${error.message}`);
        }
    }

    function renderInvestments() {
        investmentListContainer.innerHTML = '';
        noInvestmentsMessage.classList.toggle('hidden', allInvestments.length > 0);

        allInvestments.forEach(inv => createInvestmentCard(inv));
        updateSummary();
    }
    
    function createInvestmentCard(inv) {
        const template = document.getElementById('investment-card-template');
        const card = template.content.cloneNode(true).firstElementChild;
        
        card.querySelector('[data-id]').textContent = inv.id;
        card.querySelector('[data-description]').textContent = inv.descripcion;
        
        const statusEl = card.querySelector('[data-status]');
        statusEl.textContent = inv.estado;
        if (inv.estado === 'Recibido') statusEl.className += ' bg-green-500';
        else if (inv.estado === 'En Camino') statusEl.className += ' bg-blue-500';
        else if (inv.estado === 'Retenido') statusEl.className += ' bg-yellow-500';

        const items = Array.isArray(inv.items) ? inv.items : [];
        const itemsValue = items.reduce((sum, item) => sum + (item.quantity * item.unit_cost), 0);
        const totalValue = itemsValue + (inv.costo_envio || 0);
        
        card.querySelector('[data-items-value]').textContent = `R$${itemsValue.toFixed(2)}`;
        card.querySelector('[data-total-value]').textContent = `R$${totalValue.toFixed(2)}`;
        
        const trackingLink = card.querySelector('[data-tracking]');
        if(inv.tracking) {
            trackingLink.textContent = inv.tracking;
            trackingLink.href = `https://www.google.com/search?q=${inv.tracking}`;
        } else {
            trackingLink.textContent = 'N/A';
            trackingLink.href = '#';
        }

        card.querySelector('[data-shipping-date]').textContent = inv.fecha_envio || 'N/A';
        
        const itemsList = card.querySelector('[data-items]');
        inv.items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.quantity}x ${item.name} @ R$${item.unit_cost.toFixed(2)}`;
            itemsList.appendChild(li);
        });

        card.querySelector('[data-action="edit"]').addEventListener('click', () => prepareEditForm(inv.id));
        card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteInvestment(inv.id, inv.descripcion));
        
        investmentListContainer.appendChild(card);
    }
    
    function updateSummary() {
        let totalInvested = 0, totalOnTheWay = 0, totalReceived = 0, totalRetained = 0;
        allInvestments.forEach(inv => {
            const totalValue = inv.items.reduce((s, i) => s + (i.quantity * i.unit_cost), 0) + (inv.costo_envio || 0);
            totalInvested += totalValue;
            if (inv.estado === 'En Camino') totalOnTheWay += totalValue;
            else if (inv.estado === 'Recibido') totalReceived += totalValue;
            else if (inv.estado === 'Retenido') totalRetained += totalValue;
        });
        document.getElementById('total-invested-value').textContent = `R$${totalInvested.toFixed(2)}`;
        document.getElementById('total-on-the-way-value').textContent = `R$${totalOnTheWay.toFixed(2)}`;
        document.getElementById('total-received-value').textContent = `R$${totalReceived.toFixed(2)}`;
        document.getElementById('total-retained-value').textContent = `R$${totalRetained.toFixed(2)}`;
    }

    // --- FORM LOGIC ---
    function clearForm() {
        editingInvestmentId = null;
        investmentForm.reset();
        formTitle.textContent = 'Adicionar Novo Investimento';
        saveButton.textContent = 'Salvar';
        document.getElementById('investment-id').value = '';
        formItems = [];
        renderFormItems();
    }

    async function prepareEditForm(id) {
        try {
            const inv = await fetchApi(`/inversiones/${id}`);
            editingInvestmentId = inv.id;
            formTitle.textContent = 'Editar Investimento';
            saveButton.textContent = 'Atualizar';
            document.getElementById('investment-id').value = inv.id;
            document.getElementById('inv-description').value = inv.descripcion;
            document.getElementById('inv-shipping-cost').value = inv.costo_envio || 0;
            document.getElementById('inv-status').value = inv.estado;
            document.getElementById('inv-shipping-date').value = inv.fecha_envio || '';
            document.getElementById('inv-arrival-date').value = inv.fecha_llegada || '';
            document.getElementById('inv-tracking').value = inv.tracking || '';
            document.getElementById('inv-obs').value = inv.observaciones || '';
            formItems = inv.items.map(item => ({...item, product_id: item.product_id}));
            renderFormItems();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (error) {
            alert(`Erro ao carregar dados para edi√ß√£o: ${error.message}`);
        }
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const payload = {
            inversion_data: {
                descripcion: document.getElementById('inv-description').value,
                costo_envio: parseFloat(document.getElementById('inv-shipping-cost').value),
                estado: document.getElementById('inv-status').value,
                fecha_envio: document.getElementById('inv-shipping-date').value || null,
                fecha_llegada: document.getElementById('inv-arrival-date').value || null,
                tracking: document.getElementById('inv-tracking').value,
                observaciones: document.getElementById('inv-obs').value
            },
            items: formItems
        };
        
        try {
            if (editingInvestmentId) {
                await fetchApi(`/inversiones/${editingInvestmentId}`, { method: 'PUT', body: JSON.stringify(payload) });
                alert('Investimento atualizado com sucesso!');
            } else {
                await fetchApi('/inversiones', { method: 'POST', body: JSON.stringify(payload) });
                alert('Investimento adicionado com sucesso!');
            }
            clearForm();
            loadInvestments();
        } catch (error) {
            alert(`Erro ao salvar investimento: ${error.message}`);
        }
    }
    
    async function deleteInvestment(id, description) {
        if (!confirm(`Tem certeza que deseja excluir o investimento "${description}"?`)) return;
        try {
            await fetchApi(`/inversiones/${id}`, { method: 'DELETE' });
            alert('Investimento exclu√≠do com sucesso!');
            loadInvestments();
        } catch (error) {
            alert(`Erro ao excluir investimento: ${error.message}`);
        }
    }

    // --- PRODUCT & ITEM MANAGEMENT ---
    function openProductModal() {
        productSearchInput.value = '';
        productModal.classList.remove('hidden');
        loadProductsForModal('');
    }

    async function loadProductsForModal(searchText) {
        try {
            const products = await fetchApi(`/products?filter_text=${searchText}`);
            productListContainer.innerHTML = '';
            products.forEach(p => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-slate-100 cursor-pointer border-b';
                div.textContent = `${p.name} (Marca: ${p.brand || 'N/A'})`;
                div.addEventListener('click', () => selectProduct(p));
                productListContainer.appendChild(div);
            });
        } catch (error) {
            alert(`Erro ao carregar produtos: ${error.message}`);
        }
    }

    function selectProduct(product) {
        const quantity = parseInt(prompt(`Quantidade para "${product.name}":`, '1'), 10);
        if (isNaN(quantity) || quantity <= 0) return;

        const cost = parseFloat(prompt(`Custo unit√°rio para "${product.name}":`, product.costo || '0.0'));
        if (isNaN(cost) || cost < 0) return;
        
        formItems.push({
            product_id: product.id,
            name: product.name,
            quantity: quantity,
            unit_cost: cost
        });
        
        renderFormItems();
        productModal.classList.add('hidden');
    }

    function renderFormItems() {
        itemListEl.innerHTML = '';
        const template = document.getElementById('item-list-row-template');
        formItems.forEach((item, index) => {
            const li = template.content.cloneNode(true).firstElementChild;
            li.querySelector('.item-text').textContent = `${item.quantity}x ${item.name} @ R$${item.unit_cost.toFixed(2)}`;
            li.querySelector('.item-remove-btn').addEventListener('click', () => {
                formItems.splice(index, 1);
                renderFormItems();
            });
            itemListEl.appendChild(li);
        });
    }
    
    // --- EVENT LISTENERS ---
    searchInput.addEventListener('input', loadInvestments);
    statusFilter.addEventListener('change', loadInvestments);
    investmentForm.addEventListener('submit', handleFormSubmit);
    clearButton.addEventListener('click', clearForm);
    logoutButton.addEventListener('click', () => {
        localStorage.removeItem('authToken');
        sessionStorage.removeItem('authToken');

        window.location.href = 'index.html';
    });
    
    addItemBtn.addEventListener('click', openProductModal);
    closeProductModalBtn.addEventListener('click', () => productModal.classList.add('hidden'));
    productSearchInput.addEventListener('input', (e) => loadProductsForModal(e.target.value));

    // --- INITIALIZATION ---
    loadInvestments();
});
</script>
</body>
</html>
